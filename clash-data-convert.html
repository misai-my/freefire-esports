<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clash Squad JSON Viewer</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#060b18;
      --panel:#081226;
      --panel2:#0d1830;
      --line:rgba(124,172,255,.14);
      --ink:#eef4ff;
      --muted:#9fb0d1;
      --orange:#ff7f32;
      --cyan:#2dafff;
      --danger:#ff7b7b;
      --shadow:0 24px 60px rgba(0,0,0,.45);
      --radius:24px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 0% 10%, rgba(0,180,255,.12), transparent 20%),
        radial-gradient(circle at 100% 10%, rgba(255,90,0,.10), transparent 20%),
        linear-gradient(180deg,#030814 0%,#071122 100%);
      color:var(--ink);
    }

    .app{
      max-width:1720px;
      margin:0 auto;
      padding:18px;
    }

    .title{
      margin:0 0 6px;
      font-size:28px;
      font-weight:900;
      letter-spacing:.02em;
    }

    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }

    .panel{
      background:linear-gradient(180deg, rgba(10,20,42,.94), rgba(7,14,30,.96));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .input-panel{
      padding:16px;
      margin-bottom:18px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .field label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }

    textarea{
      width:100%;
      min-height:220px;
      resize:vertical;
      border-radius:16px;
      border:1px solid var(--line);
      background:#08111f;
      color:var(--ink);
      padding:12px;
      outline:none;
      font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }

    textarea:focus{
      border-color:rgba(45,175,255,.45);
      box-shadow:0 0 0 3px rgba(45,175,255,.10);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }

    button{
      border:0;
      border-radius:12px;
      padding:10px 16px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(90deg, var(--cyan), #68ffd7);
      color:#08101d;
    }

    button.ghost{
      background:transparent;
      color:var(--ink);
      border:1px solid var(--line);
    }

    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      white-space:pre-wrap;
    }

    .status.error{
      color:#ffd7d7;
      border-color:rgba(255,123,123,.35);
      background:rgba(255,123,123,.08);
    }

    .note{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px dashed var(--line);
      padding-top:12px;
      line-height:1.5;
    }

    code{
      background:rgba(255,255,255,.05);
      padding:2px 6px;
      border-radius:6px;
    }

    .arena-wrap{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:26px;
      margin-bottom:22px;
    }

    .team-panel{
      position:relative;
      overflow:visible;
      border-radius:28px;
      padding:22px 18px 18px;
      border:1px solid rgba(124,172,255,.12);
      background:
        linear-gradient(180deg, rgba(7,18,38,.95), rgba(5,14,30,.96)),
        linear-gradient(90deg, rgba(45,175,255,.04), rgba(255,127,50,.03));
      box-shadow:var(--shadow);
    }

    .team-panel::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:28px;
      pointer-events:none;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.025);
    }

    .team-glow{
      position:absolute;
      width:220px;
      height:220px;
      filter:blur(70px);
      opacity:.22;
      pointer-events:none;
    }

    .team-glow-left{
      top:-40px;
      left:-60px;
      background:#12b7ff;
    }

    .team-glow-right{
      top:-40px;
      right:-60px;
      background:#ff5a2d;
    }

    .team-header{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }

    .team-title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .team-kicker{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .team-title{
      margin:0;
      font-size:34px;
      line-height:1;
      font-weight:900;
      color:var(--orange);
      text-transform:uppercase;
    }

    .score-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .score-label{
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .score-pill{
      min-width:84px;
      text-align:center;
      padding:10px 14px;
      border-radius:16px;
      border:1px solid rgba(124,172,255,.18);
      background:rgba(3,12,28,.72);
      color:#fff;
      font-size:28px;
      font-weight:900;
      line-height:1;
    }

    .player-lanes{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:16px;
    }

    .player-lane{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }

    .hero-card{
      position:relative;
      border-radius:18px;
      padding:4px;
      background:linear-gradient(180deg, rgba(55,133,255,.25), rgba(255,127,50,.10));
      border:1px solid rgba(124,172,255,.14);
    }

    .hero-card-inner{
      position:relative;
      height:164px; /* slightly smaller */
      border-radius:15px;
      overflow:hidden;
      background:
        radial-gradient(circle at 50% 10%, rgba(255,255,255,.08), transparent 35%),
        linear-gradient(180deg, rgba(7,14,27,.75), rgba(2,8,18,.92));
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }

    .hero-card-inner img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      padding:12px;
    }

    .hero-fallback{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
    }

    .char-name{
      text-align:center;
      font-size:14px;
      font-weight:800;
      color:#dfe9ff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .player-tag{
      border:1px solid rgba(124,172,255,.14);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      min-height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      text-align:center;
      font-size:13px;
      font-weight:700;
      color:#f2f6ff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .skill-chip-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      min-height:72px;
    }

    .skill-chip{
      position:relative;
      width:74px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width:0;
    }

    .skill-chip-icon{
      width:52px;
      height:52px;
      border-radius:14px;
      border:1px solid rgba(124,172,255,.18);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }

    .skill-chip-icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:4px;
    }

    .skill-chip-label{
      width:100%;
      font-size:11px;
      line-height:1.15;
      text-align:center;
      font-weight:700;
      color:#dfe9ff;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
      min-height:24px;
    }

    .icon-fallback{
      font-size:10px;
      color:var(--muted);
      padding:4px;
      text-align:center;
    }

    .hover-wrap{
      position:relative;
      outline:none;
    }

    .hover-popup{
      position:absolute;
      left:50%;
      bottom:calc(100% + 10px);
      transform:translateX(-50%) translateY(6px);
      width:min(280px, calc(100vw - 32px));
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(124,172,255,.18);
      background:rgba(5,12,24,.98);
      box-shadow:0 18px 36px rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition:opacity .16s ease, transform .16s ease;
      z-index:50;
      text-align:left;
    }

    .hover-popup::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-7px;
      width:12px;
      height:12px;
      transform:translateX(-50%) rotate(45deg);
      background:rgba(5,12,24,.98);
      border-right:1px solid rgba(124,172,255,.18);
      border-bottom:1px solid rgba(124,172,255,.18);
    }

    .hover-wrap:hover .hover-popup,
    .hover-wrap:focus-within .hover-popup{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    .hover-title{
      font-size:12px;
      font-weight:800;
      color:#fff;
      margin-bottom:4px;
      line-height:1.3;
    }

    .hover-meta{
      font-size:11px;
      color:#7fe0ff;
      font-weight:700;
      margin-bottom:6px;
      line-height:1.3;
    }

    .hover-body{
      font-size:11px;
      color:#d3dffc;
      line-height:1.45;
    }

    .slot-stack{
      display:grid;
      gap:8px;
    }

    .slot-box{
      min-height:54px;
      border-radius:16px;
      border:1px solid rgba(124,172,255,.12);
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)),
        linear-gradient(90deg, rgba(85,130,255,.06), rgba(255,140,70,.04));
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px;
      min-width:0;
    }

    .slot-box.primary{
      border-color:rgba(255,173,58,.55);
      box-shadow:inset 0 0 0 1px rgba(255,173,58,.18);
    }

    .slot-thumb{
      width:36px;
      height:36px;
      border-radius:10px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(124,172,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }

    .slot-thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:3px;
    }

    .slot-copy{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      width:100%;
    }

    .slot-title{
      font-size:12px;
      font-weight:700;
      color:#eef4ff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .slot-sub{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .slot-empty{
      opacity:.75;
    }

    .slot-empty .slot-title{
      color:var(--muted);
    }

    .details-panel{
      padding:16px;
      overflow:hidden;
    }

    .details-title{
      margin:0 0 12px;
      font-size:18px;
      font-weight:900;
      letter-spacing:.02em;
    }

    .details-sub{
      margin:0 0 12px;
      color:var(--muted);
      font-size:12px;
    }

    .table-wrap{
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:860px;
    }

    thead th{
      position:sticky;
      top:0;
      z-index:1;
      background:rgba(8,18,38,.98);
      color:#cfe0ff;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      text-align:left;
      padding:12px 10px;
      border-bottom:1px solid var(--line);
    }

    tbody td{
      padding:10px;
      font-size:12px;
      color:#e9f1ff;
      border-top:1px solid rgba(124,172,255,.10);
      vertical-align:top;
    }

    tbody tr:nth-child(even){
      background:rgba(255,255,255,.02);
    }

    .td-muted{
      color:var(--muted);
    }

    .desc-cell{
      line-height:1.45;
      color:#d7e4ff;
      white-space:normal;
    }

    .empty-row{
      color:var(--muted);
      text-align:center;
      padding:18px !important;
    }

    @media (max-width:1100px){
      .arena-wrap{
        grid-template-columns:1fr;
      }
    }

    @media (max-width:560px){
      .team-header{
        flex-direction:column;
        align-items:flex-start;
      }

      .team-title{
        font-size:28px;
      }

      .player-lanes{
        grid-template-columns:repeat(auto-fit,minmax(135px,1fr));
      }

      .hero-card-inner{
        height:150px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1 class="title">Clash Squad JSON → Team Viewer</h1>
    <p class="sub">Paste your match JSON, then render.</p>

    <div class="panel input-panel">
      <div class="field">
        <label for="jsonInput">Paste Match JSON</label>
        <textarea id="jsonInput" placeholder='Paste the full JSON here...'></textarea>
      </div>

      <div class="actions">
        <button id="renderBtn">Render</button>
        <button id="reloadLookupBtn" class="ghost" type="button">Reload Lookup + Images</button>
        <button id="clearBtn" class="ghost" type="button">Clear</button>
      </div>

      <div id="status" class="status">Loading lookup and image catalogs…</div>

      <div class="note">
        Uses:
        <br>• <code>type = 1</code> → items
        <br>• <code>type = 2</code> → skills
        <br>• <code>type = 3</code> → pets
      </div>
    </div>

    <div class="arena-wrap">
      <section class="team-panel">
        <div class="team-glow team-glow-left"></div>
        <div class="team-header">
          <div class="team-title-block">
            <div class="team-kicker">TEAM A</div>
            <h2 id="teamAName" class="team-title">—</h2>
          </div>
          <div class="score-wrap">
            <span class="score-label">Score</span>
            <span id="teamAScore" class="score-pill">—</span>
          </div>
        </div>
        <div id="teamAPlayers" class="player-lanes"></div>
      </section>

      <section class="team-panel">
        <div class="team-glow team-glow-right"></div>
        <div class="team-header">
          <div class="team-title-block">
            <div class="team-kicker">TEAM B</div>
            <h2 id="teamBName" class="team-title">—</h2>
          </div>
          <div class="score-wrap">
            <span class="score-label">Score</span>
            <span id="teamBScore" class="score-pill">—</span>
          </div>
        </div>
        <div id="teamBPlayers" class="player-lanes"></div>
      </section>
    </div>

    <section class="panel details-panel">
      <h3 class="details-title">Skill Details</h3>
      <p class="details-sub">Active, passive, and pet skill details for all displayed players.</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th>Player</th>
              <th>Type</th>
              <th>Name</th>
              <th>Skill</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody id="skillDetailsBody">
            <tr><td colspan="6" class="empty-row">Render a match to view skill details.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    /* ============ Supabase init ============ */
    const client = supabase.createClient(
      'https://gkugecflfddkpitlrmws.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
    );

    /* ============ Remote catalogs ============ */
    const CHARACTER_JSON_URL = 'https://misai-my.github.io/freefire-esports/character.json';
    const PET_JSON_URL = 'https://misai-my.github.io/freefire-esports/pet.json';
    const WEAPON_JSON_URL = 'https://misai-my.github.io/freefire-esports/weapon.json';

    const $ = (id) => document.getElementById(id);

    let matchApiLoaded = false;
    let assetsLoaded = false;

    const LOOKUPS = {
      items: new Map(),
      skills: new Map(),
      pets: new Map()
    };

    const ASSETS = {
      charactersById: new Map(),
      charactersByName: new Map(),
      petsByName: new Map(),
      weaponsByName: new Map()
    };

    function setStatus(message, isError = false) {
      const el = $("status");
      el.textContent = message;
      el.className = isError ? "status error" : "status";
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeHtmlWithBreaks(value) {
      return escapeHtml(value ?? "").replace(/\n/g, "<br>");
    }

    function normalizeKey(value) {
      return String(value ?? "")
        .trim()
        .toUpperCase()
        .replace(/[^A-Z0-9]+/g, "");
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch ${url} (${res.status})`);
      return res.json();
    }

    function getLookupName(type, id) {
      if (id === null || id === undefined || id === "") return null;
      const numId = Number(id);

      if (type === 1) return LOOKUPS.items.get(numId) || null;
      if (type === 2) return LOOKUPS.skills.get(numId) || null;
      if (type === 3) return LOOKUPS.pets.get(numId) || null;

      return null;
    }

    async function loadMatchApiLookups() {
      const { data, error } = await client
        .from("match_api")
        .select("id, type, name")
        .in("type", [1, 2, 3]);

      if (error) throw error;

      LOOKUPS.items.clear();
      LOOKUPS.skills.clear();
      LOOKUPS.pets.clear();

      for (const row of (data || [])) {
        const id = Number(row.id);
        const type = Number(row.type);
        const name = String(row.name || "").trim();

        if (!Number.isFinite(id) || !name) continue;

        if (type === 1) LOOKUPS.items.set(id, name);
        if (type === 2) LOOKUPS.skills.set(id, name);
        if (type === 3) LOOKUPS.pets.set(id, name);
      }

      matchApiLoaded = true;

      return {
        items: LOOKUPS.items.size,
        skills: LOOKUPS.skills.size,
        pets: LOOKUPS.pets.size
      };
    }

    async function loadAssetCatalogs() {
      const [characters, pets, weapons] = await Promise.all([
        fetchJson(CHARACTER_JSON_URL),
        fetchJson(PET_JSON_URL),
        fetchJson(WEAPON_JSON_URL)
      ]);

      ASSETS.charactersById.clear();
      ASSETS.charactersByName.clear();
      ASSETS.petsByName.clear();
      ASSETS.weaponsByName.clear();

      for (const row of (characters || [])) {
        const imageUrl = row?.image_url || "";
        const apiId = Number(row?.api_id);
        const asset = {
          name: row?.name || "",
          image_url: imageUrl,
          skill: row?.skill || "",
          description: row?.description || "",
          skill_type: row?.skill_type || "",
          role: row?.role || ""
        };

        if (imageUrl && Number.isFinite(apiId)) {
          ASSETS.charactersById.set(apiId, asset);
        }

        if (row?.name) {
          ASSETS.charactersByName.set(normalizeKey(row.name), asset);
        }

        if (row?.skill) {
          ASSETS.charactersByName.set(normalizeKey(row.skill), asset);
        }
      }

      for (const row of (pets || [])) {
        const imageUrl = row?.image_url || "";
        if (!row?.name) continue;

        ASSETS.petsByName.set(normalizeKey(row.name), {
          name: row.name,
          image_url: imageUrl,
          skill: row?.skill || "",
          description: row?.description || "",
          skill_type: row?.skill_type || "",
          role: row?.role || ""
        });
      }

      for (const row of (weapons || [])) {
        if (!row?.name) continue;

        ASSETS.weaponsByName.set(normalizeKey(row.name), {
          name: row.name,
          image_url: row?.image_url || "",
          description: row?.description || ""
        });
      }

      assetsLoaded = true;

      return {
        characters: ASSETS.charactersById.size,
        pets: ASSETS.petsByName.size,
        weapons: ASSETS.weaponsByName.size
      };
    }

    async function warmUp() {
      setStatus("Loading lookup and image catalogs...");

      const [lookupResult, assetResult] = await Promise.allSettled([
        loadMatchApiLookups(),
        loadAssetCatalogs()
      ]);

      const errors = [];

      if (lookupResult.status === "rejected") {
        matchApiLoaded = false;
        errors.push(`match_api: ${lookupResult.reason?.message || lookupResult.reason}`);
      }

      if (assetResult.status === "rejected") {
        assetsLoaded = false;
        errors.push(`image catalogs: ${assetResult.reason?.message || assetResult.reason}`);
      }

      if (errors.length) {
        setStatus(`Some data failed to load:\n${errors.join("\n")}`, true);
        return;
      }

      setStatus(
        `Ready.\n` +
        `match_api → Items ${lookupResult.value.items}, Skills ${lookupResult.value.skills}, Pets ${lookupResult.value.pets}\n` +
        `Images → Characters ${assetResult.value.characters}, Pets ${assetResult.value.pets}, Weapons ${assetResult.value.weapons}`
      );
    }

    function getCharacterAsset(skillId, fallbackName = "") {
      const byId = ASSETS.charactersById.get(Number(skillId));
      if (byId) return byId;

      if (fallbackName) {
        const byName = ASSETS.charactersByName.get(normalizeKey(fallbackName));
        if (byName) return byName;
      }

      return null;
    }

    function getPetAsset(name = "") {
      if (!name) return null;
      return ASSETS.petsByName.get(normalizeKey(name)) || null;
    }

    function getWeaponAsset(name = "") {
      if (!name) return null;
      return ASSETS.weaponsByName.get(normalizeKey(name)) || null;
    }

    function getActiveSkillInfo(player) {
      const info = Array.isArray(player?.skill_info) ? player.skill_info : [];
      return info.find(s => s && s.skill_active === true) || info[0] || null;
    }

    function getActiveSkillId(player) {
      const activeInfo = getActiveSkillInfo(player);
      return activeInfo?.skill_id ?? (Array.isArray(player?.skill_ids) ? player.skill_ids[0] : null);
    }

    function getActiveSkillEntry(player) {
      const activeInfo = getActiveSkillInfo(player);
      const activeId = getActiveSkillId(player);

      if (!activeId) {
        return {
          id: null,
          label: "—",
          skill: "",
          description: "",
          image_url: "",
          slotType: "Active"
        };
      }

      const lookupName = getLookupName(2, activeId) || activeInfo?.skill_name || `Skill ID ${activeId}`;
      const asset = getCharacterAsset(activeId, lookupName);

      return {
        id: Number(activeId),
        label: asset?.name || lookupName,
        skill: asset?.skill || activeInfo?.skill_name || lookupName,
        description: asset?.description || "",
        image_url: asset?.image_url || "",
        slotType: "Active"
      };
    }

    function getPassiveSkillEntries(player) {
      const ids = Array.isArray(player?.skill_ids) ? player.skill_ids : [];
      const activeId = getActiveSkillId(player);

      const uniquePassiveIds = [...new Set(
        ids.filter(id => Number(id) !== Number(activeId))
      )];

      return uniquePassiveIds.map(id => {
        const lookupName = getLookupName(2, id) || `Skill ID ${id}`;
        const asset = getCharacterAsset(id, lookupName);

        return {
          id: Number(id),
          label: asset?.name || lookupName,
          skill: asset?.skill || lookupName,
          description: asset?.description || "",
          image_url: asset?.image_url || "",
          slotType: "Passive"
        };
      });
    }

    function getPetEntry(player) {
      const petId = player?.pet_skill_id;
      if (!petId) {
        return {
          id: null,
          label: "—",
          skill: "",
          description: "",
          image_url: "",
          slotType: "Pet"
        };
      }

      const lookupName = getLookupName(3, petId) || `Pet ID ${petId}`;
      const asset = getPetAsset(lookupName);

      return {
        id: Number(petId),
        label: asset?.name || lookupName,
        skill: asset?.skill || lookupName,
        description: asset?.description || "",
        image_url: asset?.image_url || "",
        slotType: "Pet"
      };
    }

    function getWeapons(player) {
      const weaponMap = new Map();
      const rounds = Array.isArray(player?.round_stats) ? player.round_stats : [];

      for (const round of rounds) {
        const usages = Array.isArray(round?.weapon_usages) ? round.weapon_usages : [];

        for (const weapon of usages) {
          const key = weapon?.weapon_name || `Weapon ID ${weapon?.weapon_id ?? "?"}`;

          if (!weaponMap.has(key)) {
            weaponMap.set(key, {
              id: weapon?.weapon_id ?? null,
              name: key,
              kills: 0,
              damage: 0,
              hits: 0,
              image_url: ""
            });
          }

          const row = weaponMap.get(key);
          row.kills += Number(weapon?.kills || 0);
          row.damage += Number(weapon?.damage || 0);
          row.hits += Number(weapon?.hits || 0);
        }
      }

      const list = [...weaponMap.values()].sort((a, b) =>
        (b.kills - a.kills) ||
        (b.damage - a.damage) ||
        a.name.localeCompare(b.name)
      );

      for (const weapon of list) {
        const asset = getWeaponAsset(weapon.name);
        weapon.image_url = asset?.image_url || "";
      }

      return list;
    }

    function getLatestItems(player) {
      const rounds = Array.isArray(player?.round_stats) ? [...player.round_stats] : [];
      if (!rounds.length) return [];

      rounds.sort((a, b) => Number(b?.round_index ?? -1) - Number(a?.round_index ?? -1));

      let chosenRound = rounds.find(round =>
        Array.isArray(round?.item_nums) && round.item_nums.some(item => Number(item?.item_num || 0) > 0)
      );

      if (!chosenRound) {
        chosenRound = rounds[0];
      }

      const items = Array.isArray(chosenRound?.item_nums) ? chosenRound.item_nums : [];

      return items
        .filter(item => Number(item?.item_num || 0) > 0)
        .map(item => {
          const id = Number(item?.item_id);
          const name = getLookupName(1, id) || item?.item_name || `Item ID ${id}`;
          const asset = getWeaponAsset(name);

          return {
            id,
            name,
            count: Number(item?.item_num || 0),
            image_url: asset?.image_url || ""
          };
        });
    }

    function getTeamScore(team) {
      return (
        team?.score ??
        team?.team_score ??
        team?.round_wins ??
        team?.win_rounds ??
        team?.total_round_wins ??
        "—"
      );
    }

    function renderHeroImage(imageUrl, alt) {
      if (!imageUrl) {
        return `<div class="hero-fallback">No Image</div>`;
      }
      return `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(alt)}" loading="lazy">`;
    }

    function renderMiniIcon(imageUrl, alt, label = "N/A") {
      if (!imageUrl) {
        return `<span class="icon-fallback">${escapeHtml(label)}</span>`;
      }
      return `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(alt)}" loading="lazy">`;
    }

    function renderTooltip(entry) {
      if (!entry || (!entry.skill && !entry.description)) return "";

      const meta = entry.slotType ? `${entry.slotType}${entry.label ? " • " + entry.label : ""}` : (entry.label || "");
      return `
        <div class="hover-popup">
          <div class="hover-title">${escapeHtml(entry.skill || entry.label || "Skill")}</div>
          <div class="hover-meta">${escapeHtml(meta)}</div>
          <div class="hover-body">${escapeHtmlWithBreaks(entry.description || "No description available.")}</div>
        </div>
      `;
    }

    function renderSkillChip(entry) {
      if (!entry) return "";

      return `
        <div class="skill-chip hover-wrap" tabindex="0">
          <div class="skill-chip-icon">
            ${entry.image_url
              ? `<img src="${escapeHtml(entry.image_url)}" alt="${escapeHtml(entry.label)}" loading="lazy">`
              : `<span class="icon-fallback">N/A</span>`
            }
          </div>
          <div class="skill-chip-label">${escapeHtml(entry.label || "—")}</div>
          ${renderTooltip(entry)}
        </div>
      `;
    }

    function renderSlot(entry, isPrimary = false) {
      if (!entry || !entry.name) {
        return `
          <div class="slot-box ${isPrimary ? "primary" : ""} slot-empty">
            <div class="slot-thumb"><span class="icon-fallback">—</span></div>
            <div class="slot-copy">
              <div class="slot-title">Empty Slot</div>
              <div class="slot-sub">No data</div>
            </div>
          </div>
        `;
      }

      return `
        <div class="slot-box ${isPrimary ? "primary" : ""}">
          <div class="slot-thumb">
            ${
              entry.image_url
                ? `<img src="${escapeHtml(entry.image_url)}" alt="${escapeHtml(entry.name)}" loading="lazy">`
                : `<span class="icon-fallback">N/A</span>`
            }
          </div>
          <div class="slot-copy">
            <div class="slot-title">${escapeHtml(entry.name)}</div>
            <div class="slot-sub">${escapeHtml(entry.sub || "")}</div>
          </div>
        </div>
      `;
    }

    function buildLoadoutSlots(player) {
      const weapons = getWeapons(player);
      const items = getLatestItems(player);

      const topWeapon = weapons[0]
        ? {
            name: weapons[0].name,
            image_url: weapons[0].image_url || "",
            sub: `K ${weapons[0].kills} • DMG ${weapons[0].damage}`
          }
        : null;

      const secondSlot = items[0]
        ? {
            name: items[0].name,
            image_url: items[0].image_url || "",
            sub: `x${items[0].count}`
          }
        : (weapons[1]
          ? {
              name: weapons[1].name,
              image_url: weapons[1].image_url || "",
              sub: `K ${weapons[1].kills}`
            }
          : null);

      const thirdSlot = items[1]
        ? {
            name: items[1].name,
            image_url: items[1].image_url || "",
            sub: `x${items[1].count}`
          }
        : (weapons[2]
          ? {
              name: weapons[2].name,
              image_url: weapons[2].image_url || "",
              sub: `K ${weapons[2].kills}`
            }
          : null);

      return `
        <div class="slot-stack">
          ${renderSlot(topWeapon, true)}
          ${renderSlot(secondSlot, false)}
          ${renderSlot(thirdSlot, false)}
        </div>
      `;
    }

    function renderPlayerLane(player) {
      const playerName = player?.nickname || player?.account_id || "Unknown";
      const activeSkill = getActiveSkillEntry(player);
      const passiveSkills = getPassiveSkillEntries(player).slice(0, 3);
      const pet = getPetEntry(player);

      return `
        <div class="player-lane">
          <div class="hover-wrap" tabindex="0">
            <div class="hero-card">
              <div class="hero-card-inner">
                ${renderHeroImage(activeSkill.image_url, activeSkill.label)}
              </div>
            </div>
            ${renderTooltip(activeSkill)}
          </div>

          <div class="char-name">${escapeHtml(activeSkill.label || "—")}</div>

          <div class="player-tag">${escapeHtml(playerName)}</div>

          <div class="skill-chip-row">
            ${passiveSkills.length
              ? passiveSkills.map(renderSkillChip).join("")
              : `<div class="skill-chip"><div class="skill-chip-icon"><span class="icon-fallback">—</span></div><div class="skill-chip-label">Empty</div></div>`
            }
          </div>

          <div class="skill-chip-row">
            ${pet?.id
              ? renderSkillChip(pet)
              : `<div class="skill-chip"><div class="skill-chip-icon"><span class="icon-fallback">—</span></div><div class="skill-chip-label">No Pet</div></div>`
            }
          </div>

          ${buildLoadoutSlots(player)}
        </div>
      `;
    }

    function renderTeam(team, teamNameElId, teamScoreElId, playerWrapElId) {
      const teamNameEl = $(teamNameElId);
      const teamScoreEl = $(teamScoreElId);
      const playerWrapEl = $(playerWrapElId);

      const teamName = team?.team_name || "—";
      const players = Array.isArray(team?.player_stats) ? team.player_stats : [];

      teamNameEl.textContent = teamName;
      teamScoreEl.textContent = getTeamScore(team);

      if (!players.length) {
        playerWrapEl.innerHTML = `
          <div class="slot-box slot-empty">
            <div class="slot-copy">
              <div class="slot-title">No players found</div>
            </div>
          </div>
        `;
        return;
      }

      playerWrapEl.innerHTML = players.map(renderPlayerLane).join("");
    }

    function renderSkillDetailsTable(teams) {
      const body = $("skillDetailsBody");
      const rows = [];

      (teams || []).slice(0, 2).forEach(team => {
        const teamName = team?.team_name || "—";
        const players = Array.isArray(team?.player_stats) ? team.player_stats : [];

        players.forEach(player => {
          const playerName = player?.nickname || player?.account_id || "Unknown";
          const active = getActiveSkillEntry(player);
          const passives = getPassiveSkillEntries(player).slice(0, 3);
          const pet = getPetEntry(player);

          if (active?.id || active?.label !== "—") {
            rows.push({
              team: teamName,
              player: playerName,
              type: "Active",
              name: active.label || "—",
              skill: active.skill || "—",
              description: active.description || "—"
            });
          }

          passives.forEach(entry => {
            rows.push({
              team: teamName,
              player: playerName,
              type: "Passive",
              name: entry.label || "—",
              skill: entry.skill || "—",
              description: entry.description || "—"
            });
          });

          if (pet?.id) {
            rows.push({
              team: teamName,
              player: playerName,
              type: "Pet",
              name: pet.label || "—",
              skill: pet.skill || "—",
              description: pet.description || "—"
            });
          }
        });
      });

      if (!rows.length) {
        body.innerHTML = `<tr><td colspan="6" class="empty-row">No skill details found.</td></tr>`;
        return;
      }

      body.innerHTML = rows.map(row => `
        <tr>
          <td>${escapeHtml(row.team)}</td>
          <td>${escapeHtml(row.player)}</td>
          <td class="td-muted">${escapeHtml(row.type)}</td>
          <td>${escapeHtml(row.name)}</td>
          <td>${escapeHtml(row.skill)}</td>
          <td class="desc-cell">${escapeHtmlWithBreaks(row.description)}</td>
        </tr>
      `).join("");
    }

    function clearRender() {
      $("teamAName").textContent = "—";
      $("teamBName").textContent = "—";
      $("teamAScore").textContent = "—";
      $("teamBScore").textContent = "—";
      $("teamAPlayers").innerHTML = "";
      $("teamBPlayers").innerHTML = "";
      $("skillDetailsBody").innerHTML = `<tr><td colspan="6" class="empty-row">Render a match to view skill details.</td></tr>`;
    }

    function getTeamsFromPayload(data) {
      const payload = Array.isArray(data) ? data[0] : data;
      return Array.isArray(payload?.team_stats) ? payload.team_stats : [];
    }

    async function ensureResourcesLoaded() {
      const tasks = [];

      if (!matchApiLoaded) tasks.push(loadMatchApiLookups());
      if (!assetsLoaded) tasks.push(loadAssetCatalogs());

      if (!tasks.length) return;

      setStatus("Loading missing lookup/image resources...");
      await Promise.all(tasks);

      setStatus(
        `Ready.\n` +
        `match_api → Items ${LOOKUPS.items.size}, Skills ${LOOKUPS.skills.size}, Pets ${LOOKUPS.pets.size}\n` +
        `Images → Characters ${ASSETS.charactersById.size}, Pets ${ASSETS.petsByName.size}, Weapons ${ASSETS.weaponsByName.size}`
      );
    }

    async function renderJson() {
      try {
        const raw = $("jsonInput").value.trim();

        if (!raw) {
          clearRender();
          setStatus("Paste JSON first.", true);
          return;
        }

        await ensureResourcesLoaded();

        let data;
        try {
          data = JSON.parse(raw);
        } catch (err) {
          clearRender();
          setStatus(`Invalid JSON:\n${err.message}`, true);
          return;
        }

        const teams = getTeamsFromPayload(data);

        if (teams.length < 2) {
          clearRender();
          setStatus("This JSON needs at least 2 teams inside team_stats.", true);
          return;
        }

        renderTeam(teams[0], "teamAName", "teamAScore", "teamAPlayers");
        renderTeam(teams[1], "teamBName", "teamBScore", "teamBPlayers");
        renderSkillDetailsTable(teams);

        let message = `Rendered Team A (${teams[0]?.team_name || "—"}) and Team B (${teams[1]?.team_name || "—"}).`;
        if (teams.length > 2) {
          message += ` Found ${teams.length} teams total, so only the first 2 were shown.`;
        }

        setStatus(message);
      } catch (err) {
        setStatus(`Render failed:\n${err.message || err}`, true);
      }
    }

    $("renderBtn").addEventListener("click", renderJson);

    $("reloadLookupBtn").addEventListener("click", async () => {
      matchApiLoaded = false;
      assetsLoaded = false;
      try {
        await warmUp();
      } catch (err) {
        setStatus(`Reload failed:\n${err.message || err}`, true);
      }
    });

    $("clearBtn").addEventListener("click", () => {
      $("jsonInput").value = "";
      clearRender();
      setStatus("Cleared. Paste new JSON to render.");
    });

    warmUp();
  </script>
</body>
</html>
