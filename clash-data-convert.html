<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clash Squad JSON Viewer</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a2d;
      --line:rgba(255,255,255,.10);
      --ink:#eef4ff;
      --muted:#9fb0d1;
      --brand:#6cb8ff;
      --brand2:#8bffcf;
      --danger:#ff7b7b;
      --chip:rgba(255,255,255,.08);
      --shadow:0 18px 45px rgba(0,0,0,.35);
      --radius:18px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at top left, rgba(108,184,255,.12), transparent 30%),
        radial-gradient(circle at top right, rgba(139,255,207,.10), transparent 28%),
        linear-gradient(180deg, #08101d 0%, #0b1020 100%);
      color:var(--ink);
    }

    .app{
      max-width:1500px;
      margin:0 auto;
      padding:20px;
    }

    .title{
      margin:0 0 6px;
      font-size:28px;
      font-weight:800;
    }

    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .input-panel{
      padding:16px;
      margin-bottom:18px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .field label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }

    textarea{
      width:100%;
      min-height:260px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0a1222;
      color:var(--ink);
      padding:12px;
      outline:none;
      font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }

    textarea:focus{
      border-color:rgba(108,184,255,.55);
      box-shadow:0 0 0 3px rgba(108,184,255,.12);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }

    button{
      border:0;
      border-radius:12px;
      padding:10px 16px;
      font-weight:700;
      cursor:pointer;
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      color:#08101d;
    }

    button.ghost{
      background:transparent;
      color:var(--ink);
      border:1px solid var(--line);
    }

    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      white-space:pre-wrap;
    }

    .status.error{
      color:#ffd7d7;
      border-color:rgba(255,123,123,.35);
      background:rgba(255,123,123,.08);
    }

    .teams{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px;
    }

    .team-col{
      padding:16px;
      min-height:300px;
    }

    .team-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
      padding-bottom:12px;
      border-bottom:1px solid var(--line);
    }

    .team-left .team-head{
      border-left:4px solid var(--brand);
      padding-left:12px;
    }

    .team-right .team-head{
      border-right:4px solid var(--brand2);
      padding-right:12px;
    }

    .team-label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.15em;
      color:var(--muted);
    }

    .team-name{
      margin:4px 0 0;
      font-size:24px;
      line-height:1.1;
    }

    .player-count{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .players{
      display:grid;
      gap:14px;
    }

    .player-card{
      background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }

    .player-top{
      display:grid;
      grid-template-columns:92px 1fr;
      gap:12px;
      align-items:center;
      margin-bottom:14px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    .hero-frame{
      width:92px;
      height:92px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .hero-frame img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    .hero-placeholder{
      font-size:11px;
      color:var(--muted);
      text-align:center;
      padding:8px;
      line-height:1.3;
    }

    .player-name{
      margin:0 0 6px;
      font-size:18px;
      font-weight:800;
      color:#fff;
    }

    .player-sub{
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
    }

    .row{
      margin-bottom:12px;
    }

    .label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:6px;
    }

    .value-text{
      font-size:14px;
      color:var(--ink);
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px 6px 6px;
      font-size:12px;
      line-height:1.2;
      color:var(--ink);
      min-height:40px;
    }

    .chip img{
      display:block;
      border-radius:999px;
      object-fit:cover;
      background:rgba(255,255,255,.05);
      flex:0 0 auto;
    }

    .chip-lg img{
      width:46px;
      height:46px;
    }

    .chip-md img{
      width:34px;
      height:34px;
    }

    .chip-sm img{
      width:26px;
      height:26px;
    }

    .thumb-fallback{
      width:34px;
      height:34px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      color:var(--muted);
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      flex:0 0 auto;
    }

    .weapon-list, .item-list{
      display:grid;
      gap:8px;
    }

    .media-row{
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px 10px;
    }

    .media-row img{
      width:42px;
      height:42px;
      border-radius:10px;
      object-fit:contain;
      background:rgba(255,255,255,.04);
      flex:0 0 auto;
    }

    .media-fallback{
      width:42px;
      height:42px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:10px;
      flex:0 0 auto;
    }

    .media-copy{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .media-title{
      font-size:13px;
      font-weight:700;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .media-sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .empty{
      color:var(--muted);
      font-size:13px;
    }

    .note{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px dashed var(--line);
      padding-top:12px;
      line-height:1.5;
    }

    code{
      background:rgba(255,255,255,.05);
      padding:2px 6px;
      border-radius:6px;
    }

    @media (max-width: 980px){
      .teams{
        grid-template-columns:1fr;
      }
    }

    @media (max-width: 560px){
      .player-top{
        grid-template-columns:1fr;
      }

      .hero-frame{
        width:84px;
        height:84px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1 class="title">Clash Squad JSON → Team Viewer</h1>
    <p class="sub">
      Paste your match JSON, then render. This version pulls text lookups from
      <code>public.match_api</code> and images from your character, pet, and weapon catalogs.
    </p>

    <div class="panel input-panel">
      <div class="field">
        <label for="jsonInput">Paste Match JSON</label>
        <textarea id="jsonInput" placeholder='Paste the full JSON here...'></textarea>
      </div>

      <div class="actions">
        <button id="renderBtn">Render</button>
        <button id="reloadLookupBtn" class="ghost" type="button">Reload Lookup + Images</button>
        <button id="clearBtn" class="ghost" type="button">Clear</button>
      </div>

      <div id="status" class="status">Loading lookup and image catalogs…</div>

      <div class="note">
        Uses:
        <br>• <code>type = 1</code> → items
        <br>• <code>type = 2</code> → skills
        <br>• <code>type = 3</code> → pets
        <br><br>
        Images:
        <br>• skills use character portraits
        <br>• pets use pet portraits
        <br>• weapons use weapon images
        <br>• items use a best-effort image only if the item name also exists in the weapon catalog (example: Grenade)
      </div>
    </div>

    <div class="teams">
      <div class="panel team-col team-left">
        <div class="team-head">
          <div>
            <div class="team-label">Team A • Left</div>
            <h2 id="teamAName" class="team-name">—</h2>
          </div>
          <div id="teamACount" class="player-count">0 players</div>
        </div>
        <div id="teamAPlayers" class="players"></div>
      </div>

      <div class="panel team-col team-right">
        <div class="team-head">
          <div>
            <div class="team-label">Team B • Right</div>
            <h2 id="teamBName" class="team-name">—</h2>
          </div>
          <div id="teamBCount" class="player-count">0 players</div>
        </div>
        <div id="teamBPlayers" class="players"></div>
      </div>
    </div>
  </div>

  <script>
    /* ============ Supabase init ============ */
    const client = supabase.createClient(
      'https://gkugecflfddkpitlrmws.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
    );

    /* ============ Remote catalogs ============ */
    const CHARACTER_JSON_URL = 'https://misai-my.github.io/freefire-esports/character.json';
    const PET_JSON_URL = 'https://misai-my.github.io/freefire-esports/pet.json';
    const WEAPON_JSON_URL = 'https://misai-my.github.io/freefire-esports/weapon.json';

    const $ = (id) => document.getElementById(id);

    let matchApiLoaded = false;
    let assetsLoaded = false;

    const LOOKUPS = {
      items: new Map(),   // type 1
      skills: new Map(),  // type 2
      pets: new Map()     // type 3
    };

    const ASSETS = {
      charactersById: new Map(),
      charactersByName: new Map(),
      petsByName: new Map(),
      weaponsByName: new Map()
    };

    function setStatus(message, isError = false) {
      const el = $("status");
      el.textContent = message;
      el.className = isError ? "status error" : "status";
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function normalizeKey(value) {
      return String(value ?? "")
        .trim()
        .toUpperCase()
        .replace(/[^A-Z0-9]+/g, "");
    }

    function formatCount(count, label) {
      return `${count} ${label}${count === 1 ? "" : "s"}`;
    }

    function getLookupName(type, id) {
      if (id === null || id === undefined || id === "") return null;
      const numId = Number(id);

      if (type === 1) return LOOKUPS.items.get(numId) || null;
      if (type === 2) return LOOKUPS.skills.get(numId) || null;
      if (type === 3) return LOOKUPS.pets.get(numId) || null;

      return null;
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to fetch ${url} (${res.status})`);
      return res.json();
    }

    async function loadMatchApiLookups() {
      const { data, error } = await client
        .from("match_api")
        .select("id, type, name")
        .in("type", [1, 2, 3]);

      if (error) throw error;

      LOOKUPS.items.clear();
      LOOKUPS.skills.clear();
      LOOKUPS.pets.clear();

      for (const row of (data || [])) {
        const id = Number(row.id);
        const type = Number(row.type);
        const name = String(row.name || "").trim();

        if (!Number.isFinite(id) || !name) continue;

        if (type === 1) LOOKUPS.items.set(id, name);
        if (type === 2) LOOKUPS.skills.set(id, name);
        if (type === 3) LOOKUPS.pets.set(id, name);
      }

      matchApiLoaded = true;
      return {
        items: LOOKUPS.items.size,
        skills: LOOKUPS.skills.size,
        pets: LOOKUPS.pets.size
      };
    }

    async function loadAssetCatalogs() {
      const [characters, pets, weapons] = await Promise.all([
        fetchJson(CHARACTER_JSON_URL),
        fetchJson(PET_JSON_URL),
        fetchJson(WEAPON_JSON_URL)
      ]);

      ASSETS.charactersById.clear();
      ASSETS.charactersByName.clear();
      ASSETS.petsByName.clear();
      ASSETS.weaponsByName.clear();

      for (const row of (characters || [])) {
        const imageUrl = row?.image_url || "";
        const apiId = Number(row?.api_id);
        const asset = {
          name: row?.name || row?.skill || "",
          image_url: imageUrl
        };

        if (imageUrl && Number.isFinite(apiId)) {
          ASSETS.charactersById.set(apiId, asset);
        }

        if (imageUrl && row?.name) {
          ASSETS.charactersByName.set(normalizeKey(row.name), asset);
        }

        if (imageUrl && row?.skill) {
          ASSETS.charactersByName.set(normalizeKey(row.skill), asset);
        }
      }

      for (const row of (pets || [])) {
        const imageUrl = row?.image_url || "";
        if (!imageUrl || !row?.name) continue;

        ASSETS.petsByName.set(normalizeKey(row.name), {
          name: row.name,
          image_url: imageUrl
        });
      }

      for (const row of (weapons || [])) {
        const imageUrl = row?.image_url || "";
        if (!imageUrl || !row?.name) continue;

        ASSETS.weaponsByName.set(normalizeKey(row.name), {
          name: row.name,
          image_url: imageUrl
        });
      }

      assetsLoaded = true;
      return {
        characters: ASSETS.charactersById.size,
        pets: ASSETS.petsByName.size,
        weapons: ASSETS.weaponsByName.size
      };
    }

    async function warmUp() {
      setStatus("Loading lookup and image catalogs...");

      const [lookupResult, assetResult] = await Promise.allSettled([
        loadMatchApiLookups(),
        loadAssetCatalogs()
      ]);

      const errors = [];

      if (lookupResult.status === "rejected") {
        matchApiLoaded = false;
        errors.push(`match_api: ${lookupResult.reason?.message || lookupResult.reason}`);
      }

      if (assetResult.status === "rejected") {
        assetsLoaded = false;
        errors.push(`image catalogs: ${assetResult.reason?.message || assetResult.reason}`);
      }

      if (errors.length) {
        setStatus(`Some data failed to load:\n${errors.join("\n")}`, true);
        return;
      }

      setStatus(
        `Ready.\n` +
        `match_api → Items ${lookupResult.value.items}, Skills ${lookupResult.value.skills}, Pets ${lookupResult.value.pets}\n` +
        `Images → Characters ${assetResult.value.characters}, Pets ${assetResult.value.pets}, Weapons ${assetResult.value.weapons}`
      );
    }

    function getCharacterAsset(skillId, fallbackName = "") {
      const byId = ASSETS.charactersById.get(Number(skillId));
      if (byId) return byId;

      if (fallbackName) {
        const byName = ASSETS.charactersByName.get(normalizeKey(fallbackName));
        if (byName) return byName;
      }

      return null;
    }

    function getPetAsset(name = "") {
      if (!name) return null;
      return ASSETS.petsByName.get(normalizeKey(name)) || null;
    }

    function getWeaponAsset(name = "") {
      if (!name) return null;
      return ASSETS.weaponsByName.get(normalizeKey(name)) || null;
    }

    function getActiveSkillInfo(player) {
      const info = Array.isArray(player?.skill_info) ? player.skill_info : [];
      return info.find(s => s && s.skill_active === true) || info[0] || null;
    }

    function getActiveSkillId(player) {
      const activeInfo = getActiveSkillInfo(player);
      return activeInfo?.skill_id ?? (Array.isArray(player?.skill_ids) ? player.skill_ids[0] : null);
    }

    function getActiveSkillEntry(player) {
      const activeInfo = getActiveSkillInfo(player);
      const activeId = getActiveSkillId(player);

      if (!activeId) {
        return { id: null, name: "—", image_url: "" };
      }

      const name =
        getLookupName(2, activeId) ||
        activeInfo?.skill_name ||
        `Skill ID ${activeId}`;

      const asset = getCharacterAsset(activeId, name);

      return {
        id: Number(activeId),
        name,
        image_url: asset?.image_url || ""
      };
    }

    function getPassiveSkillEntries(player) {
      const ids = Array.isArray(player?.skill_ids) ? player.skill_ids : [];
      const activeId = getActiveSkillId(player);

      const uniquePassiveIds = [...new Set(
        ids.filter(id => Number(id) !== Number(activeId))
      )];

      return uniquePassiveIds.map(id => {
        const name = getLookupName(2, id) || `Skill ID ${id}`;
        const asset = getCharacterAsset(id, name);

        return {
          id: Number(id),
          name,
          image_url: asset?.image_url || ""
        };
      });
    }

    function getPetEntry(player) {
      const petId = player?.pet_skill_id;
      if (!petId) {
        return { id: null, name: "—", image_url: "" };
      }

      const name = getLookupName(3, petId) || `Pet ID ${petId}`;
      const asset = getPetAsset(name);

      return {
        id: Number(petId),
        name,
        image_url: asset?.image_url || ""
      };
    }

    function getWeapons(player) {
      const weaponMap = new Map();
      const rounds = Array.isArray(player?.round_stats) ? player.round_stats : [];

      for (const round of rounds) {
        const usages = Array.isArray(round?.weapon_usages) ? round.weapon_usages : [];

        for (const weapon of usages) {
          const key = weapon?.weapon_name || `Weapon ID ${weapon?.weapon_id ?? "?"}`;

          if (!weaponMap.has(key)) {
            weaponMap.set(key, {
              id: weapon?.weapon_id ?? null,
              name: key,
              kills: 0,
              damage: 0,
              hits: 0,
              rounds: 0,
              image_url: ""
            });
          }

          const row = weaponMap.get(key);
          row.kills += Number(weapon?.kills || 0);
          row.damage += Number(weapon?.damage || 0);
          row.hits += Number(weapon?.hits || 0);
          row.rounds += 1;
        }
      }

      const list = [...weaponMap.values()].sort((a, b) =>
        (b.kills - a.kills) ||
        (b.damage - a.damage) ||
        a.name.localeCompare(b.name)
      );

      for (const weapon of list) {
        const asset = getWeaponAsset(weapon.name);
        weapon.image_url = asset?.image_url || "";
      }

      return list;
    }

    function getLatestItems(player) {
      const rounds = Array.isArray(player?.round_stats) ? [...player.round_stats] : [];
      if (!rounds.length) return [];

      rounds.sort((a, b) => Number(b?.round_index ?? -1) - Number(a?.round_index ?? -1));

      let chosenRound = rounds.find(round =>
        Array.isArray(round?.item_nums) && round.item_nums.some(item => Number(item?.item_num || 0) > 0)
      );

      if (!chosenRound) {
        chosenRound = rounds[0];
      }

      const items = Array.isArray(chosenRound?.item_nums) ? chosenRound.item_nums : [];

      return items
        .filter(item => Number(item?.item_num || 0) > 0)
        .map(item => {
          const id = Number(item?.item_id);
          const name = getLookupName(1, id) || item?.item_name || `Item ID ${id}`;
          const asset = getWeaponAsset(name); // best effort for Grenade, etc.

          return {
            id,
            name,
            count: Number(item?.item_num || 0),
            image_url: asset?.image_url || ""
          };
        });
    }

    function renderCircleThumb(imageUrl, alt, sizeClass = "chip-md") {
      if (!imageUrl) {
        return `<span class="thumb-fallback">N/A</span>`;
      }

      return `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(alt)}" loading="lazy">`;
    }

    function renderRectThumb(imageUrl, alt) {
      if (!imageUrl) {
        return `<div class="media-fallback">N/A</div>`;
      }

      return `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(alt)}" loading="lazy">`;
    }

    function renderHeroFrame(imageUrl, alt) {
      if (!imageUrl) {
        return `<div class="hero-placeholder">No image</div>`;
      }

      return `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(alt)}" loading="lazy">`;
    }

    function renderPlayerCard(player) {
      const playerName = player?.nickname || player?.account_id || "Unknown Player";
      const activeSkill = getActiveSkillEntry(player);
      const passiveSkills = getPassiveSkillEntries(player);
      const pet = getPetEntry(player);
      const weapons = getWeapons(player);
      const items = getLatestItems(player);

      return `
        <div class="player-card">
          <div class="player-top">
            <div class="hero-frame">
              ${renderHeroFrame(activeSkill.image_url, activeSkill.name)}
            </div>
            <div>
              <h3 class="player-name">${escapeHtml(playerName)}</h3>
              <div class="player-sub">
                Main character / active skill:
                <strong>${escapeHtml(activeSkill.name)}</strong>
              </div>
            </div>
          </div>

          <div class="row">
            <span class="label">Active Skill</span>
            <div class="chips">
              <span class="chip chip-lg">
                ${renderCircleThumb(activeSkill.image_url, activeSkill.name)}
                <span>${escapeHtml(activeSkill.name)}</span>
              </span>
            </div>
          </div>

          <div class="row">
            <span class="label">Passive Skills</span>
            ${
              passiveSkills.length
                ? `
                  <div class="chips">
                    ${passiveSkills.map(skill => `
                      <span class="chip chip-md">
                        ${renderCircleThumb(skill.image_url, skill.name)}
                        <span>${escapeHtml(skill.name)}</span>
                      </span>
                    `).join("")}
                  </div>
                `
                : `<div class="empty">No passive skill IDs found</div>`
            }
          </div>

          <div class="row">
            <span class="label">Pet</span>
            ${
              pet.id
                ? `
                  <div class="chips">
                    <span class="chip chip-md">
                      ${renderCircleThumb(pet.image_url, pet.name)}
                      <span>${escapeHtml(pet.name)}</span>
                    </span>
                  </div>
                `
                : `<div class="empty">No pet data</div>`
            }
          </div>

          <div class="row">
            <span class="label">Weapons</span>
            ${
              weapons.length
                ? `
                  <div class="weapon-list">
                    ${weapons.map(weapon => `
                      <div class="media-row">
                        ${renderRectThumb(weapon.image_url, weapon.name)}
                        <div class="media-copy">
                          <div class="media-title">${escapeHtml(weapon.name)}</div>
                          <div class="media-sub">K ${weapon.kills} • DMG ${weapon.damage} • Hits ${weapon.hits}</div>
                        </div>
                      </div>
                    `).join("")}
                  </div>
                `
                : `<div class="empty">No weapon data</div>`
            }
          </div>

          <div class="row">
            <span class="label">Items (latest round with inventory)</span>
            ${
              items.length
                ? `
                  <div class="item-list">
                    ${items.map(item => `
                      <div class="media-row">
                        ${renderRectThumb(item.image_url, item.name)}
                        <div class="media-copy">
                          <div class="media-title">${escapeHtml(item.name)}</div>
                          <div class="media-sub">x${item.count}</div>
                        </div>
                      </div>
                    `).join("")}
                  </div>
                `
                : `<div class="empty">No item data</div>`
            }
          </div>
        </div>
      `;
    }

    function renderTeam(team, teamNameElId, teamCountElId, playerWrapElId) {
      const teamNameEl = $(teamNameElId);
      const teamCountEl = $(teamCountElId);
      const playerWrapEl = $(playerWrapElId);

      const teamName = team?.team_name || "—";
      const players = Array.isArray(team?.player_stats) ? team.player_stats : [];

      teamNameEl.textContent = teamName;
      teamCountEl.textContent = formatCount(players.length, "player");

      if (!players.length) {
        playerWrapEl.innerHTML = `<div class="player-card"><div class="empty">No players found.</div></div>`;
        return;
      }

      playerWrapEl.innerHTML = players.map(renderPlayerCard).join("");
    }

    function clearRender() {
      $("teamAName").textContent = "—";
      $("teamBName").textContent = "—";
      $("teamACount").textContent = "0 players";
      $("teamBCount").textContent = "0 players";
      $("teamAPlayers").innerHTML = "";
      $("teamBPlayers").innerHTML = "";
    }

    function getTeamsFromPayload(data) {
      const payload = Array.isArray(data) ? data[0] : data;

      if (Array.isArray(payload?.team_stats)) {
        return payload.team_stats;
      }

      return [];
    }

    async function ensureResourcesLoaded() {
      const tasks = [];

      if (!matchApiLoaded) tasks.push(loadMatchApiLookups());
      if (!assetsLoaded) tasks.push(loadAssetCatalogs());

      if (!tasks.length) return;

      setStatus("Loading missing lookup/image resources...");
      await Promise.all(tasks);

      setStatus(
        `Ready.\n` +
        `match_api → Items ${LOOKUPS.items.size}, Skills ${LOOKUPS.skills.size}, Pets ${LOOKUPS.pets.size}\n` +
        `Images → Characters ${ASSETS.charactersById.size}, Pets ${ASSETS.petsByName.size}, Weapons ${ASSETS.weaponsByName.size}`
      );
    }

    async function renderJson() {
      try {
        const raw = $("jsonInput").value.trim();

        if (!raw) {
          clearRender();
          setStatus("Paste JSON first.", true);
          return;
        }

        await ensureResourcesLoaded();

        let data;
        try {
          data = JSON.parse(raw);
        } catch (err) {
          clearRender();
          setStatus(`Invalid JSON:\n${err.message}`, true);
          return;
        }

        const teams = getTeamsFromPayload(data);

        if (teams.length < 2) {
          clearRender();
          setStatus("This JSON needs at least 2 teams inside team_stats.", true);
          return;
        }

        renderTeam(teams[0], "teamAName", "teamACount", "teamAPlayers");
        renderTeam(teams[1], "teamBName", "teamBCount", "teamBPlayers");

        let message = `Rendered Team A (${teams[0]?.team_name || "—"}) and Team B (${teams[1]?.team_name || "—"}).`;

        if (teams.length > 2) {
          message += ` Found ${teams.length} teams total, so only the first 2 were shown.`;
        }

        setStatus(message);
      } catch (err) {
        setStatus(`Render failed:\n${err.message || err}`, true);
      }
    }

    $("renderBtn").addEventListener("click", renderJson);

    $("reloadLookupBtn").addEventListener("click", async () => {
      matchApiLoaded = false;
      assetsLoaded = false;
      try {
        await warmUp();
      } catch (err) {
        setStatus(`Reload failed:\n${err.message || err}`, true);
      }
    });

    $("clearBtn").addEventListener("click", () => {
      $("jsonInput").value = "";
      clearRender();
      setStatus("Cleared. Paste new JSON to render.");
    });

    warmUp();
  </script>
</body>
</html>
