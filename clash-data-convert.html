<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clash Squad JSON Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#060b18;
      --panel:#081226;
      --line:rgba(124,172,255,.14);
      --ink:#eef4ff;
      --muted:#9fb0d1;
      --orange:#ff7f32;
      --cyan:#2dafff;
      --shadow:0 24px 60px rgba(0,0,0,.45);
      --radius:24px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 0% 10%, rgba(0,180,255,.12), transparent 20%),
        radial-gradient(circle at 100% 10%, rgba(255,90,0,.10), transparent 20%),
        linear-gradient(180deg,#030814 0%,#071122 100%);
      color:var(--ink);
    }

    .app{
      max-width:1880px;
      margin:0 auto;
      padding:18px;
    }

    .title{
      margin:0 0 6px;
      font-size:28px;
      font-weight:900;
      letter-spacing:.02em;
    }

    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }

    .panel{
      background:linear-gradient(180deg, rgba(10,20,42,.94), rgba(7,14,30,.96));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .input-panel{
      padding:16px;
      margin-bottom:18px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .field label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }

    textarea{
      width:100%;
      min-height:220px;
      resize:vertical;
      border-radius:16px;
      border:1px solid var(--line);
      background:#08111f;
      color:var(--ink);
      padding:12px;
      outline:none;
      font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }

    textarea:focus{
      border-color:rgba(45,175,255,.45);
      box-shadow:0 0 0 3px rgba(45,175,255,.10);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }

    button{
      border:0;
      border-radius:12px;
      padding:10px 16px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(90deg, var(--cyan), #68ffd7);
      color:#08101d;
    }

    button.ghost{
      background:transparent;
      color:var(--ink);
      border:1px solid var(--line);
    }

    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      white-space:pre-wrap;
    }

    .status.error{
      color:#ffd7d7;
      border-color:rgba(255,123,123,.35);
      background:rgba(255,123,123,.08);
    }

    .note{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px dashed var(--line);
      padding-top:12px;
      line-height:1.5;
    }

    code{
      background:rgba(255,255,255,.05);
      padding:2px 6px;
      border-radius:6px;
    }

    .match-head{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:14px;
      align-items:center;
      padding:14px 18px;
      margin-bottom:18px;
      border-radius:22px;
    }

    .match-team-name{
      font-size:30px;
      font-weight:900;
      color:var(--orange);
      text-transform:uppercase;
      line-height:1;
      white-space:normal;
      word-break:break-word;
    }

    .match-team-name.right{
      text-align:right;
    }

    .match-round{
      padding:10px 18px;
      border-radius:16px;
      border:1px solid rgba(124,172,255,.18);
      background:rgba(3,12,28,.72);
      font-size:20px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#fff;
      white-space:nowrap;
    }

    .arena-wrap{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:26px;
    }

    .team-panel{
      position:relative;
      overflow:visible;
      border-radius:28px;
      padding:18px;
      border:1px solid rgba(124,172,255,.12);
      background:
        linear-gradient(180deg, rgba(7,18,38,.95), rgba(5,14,30,.96)),
        linear-gradient(90deg, rgba(45,175,255,.04), rgba(255,127,50,.03));
      box-shadow:var(--shadow);
    }

    .team-panel::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:28px;
      pointer-events:none;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.025);
    }

    .team-glow{
      position:absolute;
      width:220px;
      height:220px;
      filter:blur(70px);
      opacity:.22;
      pointer-events:none;
    }

    .team-glow-left{
      top:-40px;
      left:-60px;
      background:#12b7ff;
    }

    .team-glow-right{
      top:-40px;
      right:-60px;
      background:#ff5a2d;
    }

    .player-lanes{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:18px;
    }

    .player-lane{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(124,172,255,.10);
      background:rgba(255,255,255,.02);
    }

    .hero-card{
      position:relative;
      border-radius:18px;
      padding:4px;
      background:linear-gradient(180deg, rgba(55,133,255,.25), rgba(255,127,50,.10));
      border:1px solid rgba(124,172,255,.14);
    }

    .hero-card-inner{
      position:relative;
      height:180px;
      border-radius:15px;
      overflow:hidden;
      background:
        radial-gradient(circle at 50% 10%, rgba(255,255,255,.08), transparent 35%),
        linear-gradient(180deg, rgba(7,14,27,.75), rgba(2,8,18,.92));
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }

    .hero-card-inner img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      padding:12px;
    }

    .hero-fallback{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding:10px;
    }

    .char-name{
      text-align:center;
      font-size:15px;
      font-weight:900;
      color:#dfe9ff;
      white-space:normal;
      word-break:break-word;
      line-height:1.25;
    }

    .player-tag{
      border:1px solid rgba(124,172,255,.14);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      min-height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      text-align:center;
      font-size:13px;
      font-weight:800;
      color:#f2f6ff;
      white-space:normal;
      word-break:break-word;
      line-height:1.25;
    }

    .skill-chip-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
    }

    .skill-chip{
      position:relative;
      width:92px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width:0;
    }

    .skill-chip-icon{
      width:58px;
      height:58px;
      border-radius:14px;
      border:1px solid rgba(124,172,255,.18);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }

    .skill-chip-icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:4px;
    }

    .skill-chip-label{
      width:100%;
      font-size:11px;
      line-height:1.2;
      text-align:center;
      font-weight:800;
      color:#dfe9ff;
      white-space:normal;
      word-break:break-word;
    }

    .icon-fallback{
      font-size:10px;
      color:var(--muted);
      padding:4px;
      text-align:center;
      line-height:1.2;
    }

    .hover-wrap{
      position:relative;
      outline:none;
    }

    .hover-popup{
      position:absolute;
      left:50%;
      bottom:calc(100% + 10px);
      transform:translateX(-50%) translateY(6px);
      width:min(320px, calc(100vw - 32px));
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(124,172,255,.18);
      background:rgba(5,12,24,.98);
      box-shadow:0 18px 36px rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition:opacity .16s ease, transform .16s ease;
      z-index:50;
      text-align:left;
    }

    .hover-popup::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-7px;
      width:12px;
      height:12px;
      transform:translateX(-50%) rotate(45deg);
      background:rgba(5,12,24,.98);
      border-right:1px solid rgba(124,172,255,.18);
      border-bottom:1px solid rgba(124,172,255,.18);
    }

    .hover-wrap:hover .hover-popup,
    .hover-wrap:focus-within .hover-popup{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    .hover-title{
      font-size:12px;
      font-weight:900;
      color:#fff;
      margin-bottom:4px;
      line-height:1.3;
    }

    .hover-meta{
      font-size:11px;
      color:#7fe0ff;
      font-weight:800;
      margin-bottom:6px;
      line-height:1.3;
    }

    .hover-body{
      font-size:11px;
      color:#d3dffc;
      line-height:1.45;
      white-space:normal;
    }

    .section-box{
      border-radius:18px;
      border:1px solid rgba(124,172,255,.10);
      background:rgba(255,255,255,.025);
      padding:10px;
      display:grid;
      gap:10px;
    }

    .section-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
      font-weight:900;
      white-space:normal;
      line-height:1.3;
    }

    .single-card,
    .slot-box,
    .purchase-item{
      min-height:56px;
      border-radius:14px;
      border:1px solid rgba(124,172,255,.10);
      background:rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px;
      min-width:0;
    }

    .single-card.primary,
    .slot-box.primary{
      border-color:rgba(255,173,58,.55);
      box-shadow:inset 0 0 0 1px rgba(255,173,58,.18);
    }

    .card-thumb,
    .slot-thumb,
    .purchase-thumb{
      width:38px;
      height:38px;
      border-radius:10px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(124,172,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }

    .card-thumb img,
    .slot-thumb img,
    .purchase-thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:3px;
    }

    .card-copy,
    .slot-copy,
    .purchase-copy{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      width:100%;
    }

    .card-title,
    .slot-title,
    .purchase-title{
      font-size:12px;
      font-weight:800;
      color:#eef4ff;
      white-space:normal;
      line-height:1.25;
      word-break:break-word;
    }

    .card-sub,
    .slot-sub,
    .purchase-sub{
      font-size:11px;
      color:var(--muted);
      white-space:normal;
      line-height:1.25;
      word-break:break-word;
    }

    .slot-stack,
    .purchase-list{
      display:grid;
      gap:8px;
    }

    .stats-sections{
      display:grid;
      gap:10px;
    }

    .stats-category{
      border-radius:14px;
      border:1px solid rgba(124,172,255,.08);
      background:rgba(255,255,255,.02);
      overflow:hidden;
    }

    .stats-category-title{
      padding:8px 10px;
      font-size:11px;
      font-weight:900;
      color:#cfe0ff;
      text-transform:uppercase;
      letter-spacing:.08em;
      background:rgba(255,255,255,.03);
      border-bottom:1px solid rgba(124,172,255,.08);
      white-space:normal;
      line-height:1.3;
    }

    .stats-table{
      display:grid;
    }

    .stats-row{
      display:grid;
      grid-template-columns:minmax(120px, 1fr) minmax(0, 1.4fr);
      gap:10px;
      padding:8px 10px;
      border-top:1px solid rgba(124,172,255,.06);
      align-items:start;
    }

    .stats-row:first-child{
      border-top:0;
    }

    .stats-key{
      font-size:11px;
      font-weight:800;
      color:var(--muted);
      white-space:normal;
      line-height:1.3;
      word-break:break-word;
    }

    .stats-val{
      font-size:12px;
      font-weight:700;
      color:#eef4ff;
      white-space:normal;
      line-height:1.35;
      word-break:break-word;
    }

    .empty-lite{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    @media (max-width:1200px){
      .arena-wrap{
        grid-template-columns:1fr;
      }
    }

    @media (max-width:900px){
      .match-head{
        grid-template-columns:1fr;
        justify-items:center;
        text-align:center;
      }

      .match-team-name.right{
        text-align:center;
      }
    }

    @media (max-width:640px){
      .player-lanes{
        grid-template-columns:1fr;
      }

      .hero-card-inner{
        height:160px;
      }

      .stats-row{
        grid-template-columns:1fr;
        gap:4px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1 class="title">Clash Squad JSON → Team Viewer</h1>
    <p class="sub">Paste your match JSON, then render.</p>

    <div class="panel input-panel">
      <div class="field">
        <label for="jsonInput">Paste Match JSON</label>
        <textarea id="jsonInput" placeholder='Paste the full JSON here...'></textarea>
      </div>

      <div class="actions">
        <button id="renderBtn">Render</button>
        <button id="reloadLookupBtn" class="ghost" type="button">Reload Lookup + Images</button>
        <button id="clearBtn" class="ghost" type="button">Clear</button>
      </div>

      <div id="status" class="status">Loading lookup and image catalogs…</div>

      <div class="note">
        This version:
        <br>• checks <code>match_api</code> types <code>0</code>, <code>1</code>, <code>2</code>, <code>3</code>
        <br>• uses <code>type 0</code> as a fallback for purchased items
        <br>• separates each player section into: skills, pet, loadout, item snapshot, purchased items, weapon usages, and categorized latest round stats
      </div>
    </div>

    <div class="panel match-head">
      <div id="teamAName" class="match-team-name">—</div>
      <div id="matchRound" class="match-round">ROUND —</div>
      <div id="teamBName" class="match-team-name right">—</div>
    </div>

    <div class="arena-wrap">
      <section class="team-panel">
        <div class="team-glow team-glow-left"></div>
        <div id="teamAPlayers" class="player-lanes"></div>
      </section>

      <section class="team-panel">
        <div class="team-glow team-glow-right"></div>
        <div id="teamBPlayers" class="player-lanes"></div>
      </section>
    </div>
  </div>

  <script>
    const client = supabase.createClient(
      'https://gkugecflfddkpitlrmws.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
    );

    const CHARACTER_JSON_URL = 'https://misai-my.github.io/freefire-esports/character.json';
    const PET_JSON_URL = 'https://misai-my.github.io/freefire-esports/pet.json';
    const WEAPON_JSON_URL = 'https://misai-my.github.io/freefire-esports/weapon.json';
    const LOADOUT_JSON_URL = 'https://misai-my.github.io/freefire-esports/loadout.json';

    const $ = (id) => document.getElementById(id);

    let matchApiLoaded = false;
    let assetsLoaded = false;

    const LOOKUPS = {
      storeItems: new Map(), // type 0
      items: new Map(),      // type 1
      skills: new Map(),     // type 2
      pets: new Map()        // type 3
    };

    const ASSETS = {
      charactersById: new Map(),
      charactersByName: new Map(),
      petsByName: new Map(),
      weaponsByName: new Map(),
      loadoutsById: new Map()
    };

    const LOADOUT_FALLBACKS = [
      { id: 500000003, name: 'Super Leg Pockets', image_url: '' },
      { id: 500000004, name: 'Tactical Market', image_url: '' },
      { id: 500000005, name: 'Team Booster', image_url: '' },
      { id: 500000008, name: 'Enhance Hammer', image_url: '' }
    ];

    function setStatus(message, isError = false) {
      const el = $("status");
      el.textContent = message;
      el.className = isError ? "status error" : "status";
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeHtmlWithBreaks(value) {
      return escapeHtml(value ?? "").replace(/\n/g, "<br>");
    }

    function normalizeKey(value) {
      return String(value ?? "")
        .trim()
        .toUpperCase()
        .replace(/[^A-Z0-9]+/g, "");
    }

    function toNum(value, fallback = 0) {
      const n = Number(value);
      return Number.isFinite(n) ? n : fallback;
    }

    function humanizeKey(key) {
      return String(key || "")
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function formatGenericValue(value) {
      if (value === null || value === undefined) return "—";
      if (typeof value === "boolean") return value ? "Yes" : "No";
      if (Array.isArray(value)) {
        if (!value.length) return "0";
        const allPrimitive = value.every(v =>
          v === null || ["string", "number", "boolean"].includes(typeof v)
        );
        if (allPrimitive) return value.map(v => formatGenericValue(v)).join(", ");
        return `${value.length} entries`;
      }
      if (typeof value === "object") {
        try { return JSON.stringify(value); }
        catch { return "[object]"; }
      }
      return String(value);
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch ${url} (${res.status})`);
      return res.json();
    }

    function resolveItemName(id, preferStore = false) {
      const numId = Number(id);
      if (!Number.isFinite(numId)) return null;

      if (preferStore) {
        return LOOKUPS.storeItems.get(numId) || LOOKUPS.items.get(numId) || null;
      }
      return LOOKUPS.items.get(numId) || LOOKUPS.storeItems.get(numId) || null;
    }

    function getLookupName(type, id) {
      const numId = Number(id);
      if (!Number.isFinite(numId)) return null;

      if (type === 0) return LOOKUPS.storeItems.get(numId) || null;
      if (type === 1) return LOOKUPS.items.get(numId) || null;
      if (type === 2) return LOOKUPS.skills.get(numId) || null;
      if (type === 3) return LOOKUPS.pets.get(numId) || null;
      return null;
    }

    async function loadMatchApiLookups() {
      const { data, error } = await client
        .from("match_api")
        .select("id, type, name")
        .in("type", [0, 1, 2, 3]);

      if (error) throw error;

      LOOKUPS.storeItems.clear();
      LOOKUPS.items.clear();
      LOOKUPS.skills.clear();
      LOOKUPS.pets.clear();

      for (const row of (data || [])) {
        const id = Number(row.id);
        const type = Number(row.type);
        const name = String(row.name || "").trim();

        if (!Number.isFinite(id) || !name) continue;

        if (type === 0) LOOKUPS.storeItems.set(id, name);
        if (type === 1) LOOKUPS.items.set(id, name);
        if (type === 2) LOOKUPS.skills.set(id, name);
        if (type === 3) LOOKUPS.pets.set(id, name);
      }

      matchApiLoaded = true;

      return {
        storeItems: LOOKUPS.storeItems.size,
        items: LOOKUPS.items.size,
        skills: LOOKUPS.skills.size,
        pets: LOOKUPS.pets.size
      };
    }

    function seedFallbackLoadouts() {
      ASSETS.loadoutsById.clear();
      for (const row of LOADOUT_FALLBACKS) {
        ASSETS.loadoutsById.set(Number(row.id), {
          id: Number(row.id),
          name: row.name,
          image_url: row.image_url || ""
        });
      }
    }

    function extractLoadoutRows(raw) {
      const rows = Array.isArray(raw)
        ? raw
        : (Array.isArray(raw?.data) ? raw.data : []);

      for (const row of rows) {
        const id = Number(row?.id ?? row?.api_id ?? row?.loadout_id);
        if (!Number.isFinite(id)) continue;

        const name = String(row?.name ?? row?.title ?? row?.label ?? "").trim();
        const imageUrl = String(row?.image_url ?? row?.img ?? row?.icon ?? "").trim();

        const existing = ASSETS.loadoutsById.get(id) || {};
        ASSETS.loadoutsById.set(id, {
          id,
          name: name || existing.name || `Loadout ${id}`,
          image_url: imageUrl || existing.image_url || ""
        });
      }
    }

    async function loadAssetCatalogs() {
      const [characters, pets, weapons, loadouts] = await Promise.allSettled([
        fetchJson(CHARACTER_JSON_URL),
        fetchJson(PET_JSON_URL),
        fetchJson(WEAPON_JSON_URL),
        fetchJson(LOADOUT_JSON_URL)
      ]);

      ASSETS.charactersById.clear();
      ASSETS.charactersByName.clear();
      ASSETS.petsByName.clear();
      ASSETS.weaponsByName.clear();
      seedFallbackLoadouts();

      if (characters.status === "fulfilled") {
        for (const row of (characters.value || [])) {
          const imageUrl = row?.image_url || "";
          const apiId = Number(row?.api_id);
          const asset = {
            name: row?.name || "",
            image_url: imageUrl,
            skill: row?.skill || "",
            description: row?.description || ""
          };

          if (imageUrl && Number.isFinite(apiId)) {
            ASSETS.charactersById.set(apiId, asset);
          }

          if (row?.name) {
            ASSETS.charactersByName.set(normalizeKey(row.name), asset);
          }

          if (row?.skill) {
            ASSETS.charactersByName.set(normalizeKey(row.skill), asset);
          }
        }
      }

      if (pets.status === "fulfilled") {
        for (const row of (pets.value || [])) {
          if (!row?.name) continue;
          ASSETS.petsByName.set(normalizeKey(row.name), {
            name: row.name,
            image_url: row?.image_url || "",
            skill: row?.skill || "",
            description: row?.description || ""
          });
        }
      }

      if (weapons.status === "fulfilled") {
        for (const row of (weapons.value || [])) {
          if (!row?.name) continue;
          ASSETS.weaponsByName.set(normalizeKey(row.name), {
            name: row.name,
            image_url: row?.image_url || "",
            description: row?.description || ""
          });
        }
      }

      if (loadouts.status === "fulfilled") {
        extractLoadoutRows(loadouts.value);
      }

      assetsLoaded = true;

      const problems = [];
      if (characters.status === "rejected") problems.push("character.json");
      if (pets.status === "rejected") problems.push("pet.json");
      if (weapons.status === "rejected") problems.push("weapon.json");

      return {
        characters: ASSETS.charactersById.size,
        pets: ASSETS.petsByName.size,
        weapons: ASSETS.weaponsByName.size,
        loadouts: ASSETS.loadoutsById.size,
        warnings: problems
      };
    }

    async function warmUp() {
      setStatus("Loading lookup and image catalogs...");

      const [lookupResult, assetResult] = await Promise.allSettled([
        loadMatchApiLookups(),
        loadAssetCatalogs()
      ]);

      const errors = [];

      if (lookupResult.status === "rejected") {
        matchApiLoaded = false;
        errors.push(`match_api: ${lookupResult.reason?.message || lookupResult.reason}`);
      }

      if (assetResult.status === "rejected") {
        assetsLoaded = false;
        errors.push(`asset catalogs: ${assetResult.reason?.message || assetResult.reason}`);
      }

      if (errors.length) {
        setStatus(`Some data failed to load:\n${errors.join("\n")}`, true);
        return;
      }

      const warn = assetResult.value.warnings?.length
        ? `\nWarnings: ${assetResult.value.warnings.join(", ")} failed`
        : "";

      setStatus(
        `Ready.\n` +
        `match_api → Type0 ${lookupResult.value.storeItems}, Type1 ${lookupResult.value.items}, Skills ${lookupResult.value.skills}, Pets ${lookupResult.value.pets}\n` +
        `Images → Characters ${assetResult.value.characters}, Pets ${assetResult.value.pets}, Weapons ${assetResult.value.weapons}, Loadouts ${assetResult.value.loadouts}` +
        warn
      );
    }

    function getCharacterAsset(skillId, fallbackName = "") {
      const byId = ASSETS.charactersById.get(Number(skillId));
      if (byId) return byId;

      if (fallbackName) {
        const byName = ASSETS.charactersByName.get(normalizeKey(fallbackName));
        if (byName) return byName;
      }
      return null;
    }

    function getPetAsset(name = "") {
      if (!name) return null;
      return ASSETS.petsByName.get(normalizeKey(name)) || null;
    }

    function getWeaponAsset(name = "") {
      if (!name) return null;
      return ASSETS.weaponsByName.get(normalizeKey(name)) || null;
    }

    function getLoadoutAsset(loadoutId) {
      const id = Number(loadoutId);
      if (!Number.isFinite(id)) return null;
      return ASSETS.loadoutsById.get(id) || null;
    }

    function getActiveSkillInfo(player) {
      const info = Array.isArray(player?.skill_info) ? player.skill_info : [];
      return info.find(s => s && s.skill_active === true) || info[0] || null;
    }

    function getActiveSkillId(player) {
      const activeInfo = getActiveSkillInfo(player);
      return activeInfo?.skill_id ?? (Array.isArray(player?.skill_ids) ? player.skill_ids[0] : null);
    }

    function getActiveSkillEntry(player) {
      const activeInfo = getActiveSkillInfo(player);
      const activeId = getActiveSkillId(player);

      if (!activeId) {
        return { id:null, label:"—", skill:"", description:"", image_url:"", slotType:"Active" };
      }

      const lookupName = getLookupName(2, activeId) || activeInfo?.skill_name || `Skill ID ${activeId}`;
      const asset = getCharacterAsset(activeId, lookupName);

      return {
        id: Number(activeId),
        label: asset?.name || lookupName,
        skill: asset?.skill || activeInfo?.skill_name || lookupName,
        description: asset?.description || "",
        image_url: asset?.image_url || "",
        slotType: "Active"
      };
    }

    function getPassiveSkillEntries(player) {
      const ids = Array.isArray(player?.skill_ids) ? player.skill_ids : [];
      const activeId = getActiveSkillId(player);

      const uniquePassiveIds = [...new Set(
        ids.filter(id => Number(id) !== Number(activeId))
      )];

      return uniquePassiveIds.map(id => {
        const lookupName = getLookupName(2, id) || `Skill ID ${id}`;
        const asset = getCharacterAsset(id, lookupName);

        return {
          id: Number(id),
          label: asset?.name || lookupName,
          skill: asset?.skill || lookupName,
          description: asset?.description || "",
          image_url: asset?.image_url || "",
          slotType: "Passive"
        };
      });
    }

    function getPetEntry(player) {
      const petId = player?.pet_skill_id;
      if (!petId) {
        return { id:null, label:"—", skill:"", description:"", image_url:"", slotType:"Pet" };
      }

      const lookupName = getLookupName(3, petId) || `Pet ID ${petId}`;
      const asset = getPetAsset(lookupName);

      return {
        id: Number(petId),
        label: asset?.name || lookupName,
        skill: asset?.skill || lookupName,
        description: asset?.description || "",
        image_url: asset?.image_url || "",
        slotType: "Pet"
      };
    }

    function getPlayerLoadoutId(player) {
      const candidates = [
        player?.loadout_id,
        player?.loadout,
        player?.player_stats_loadouts,
        player?.player_stats_loadout,
        player?.loadoutId
      ];

      for (const value of candidates) {
        const id = Number(value);
        if (Number.isFinite(id)) return id;
      }

      const round = getLatestRoundStat(player);
      const roundCandidates = [
        round?.loadout_id,
        round?.loadout,
        round?.player_stats_loadouts,
        round?.player_stats_loadout
      ];

      for (const value of roundCandidates) {
        const id = Number(value);
        if (Number.isFinite(id)) return id;
      }

      return null;
    }

    function getPlayerLoadoutEntry(player) {
      const id = getPlayerLoadoutId(player);
      if (!Number.isFinite(id)) {
        return { id:null, name:"No loadout found", image_url:"" };
      }

      const asset = getLoadoutAsset(id);
      return {
        id,
        name: asset?.name || `Loadout ${id}`,
        image_url: asset?.image_url || ""
      };
    }

    function getWeapons(player) {
      const weaponMap = new Map();
      const rounds = Array.isArray(player?.round_stats) ? player.round_stats : [];

      for (const round of rounds) {
        const usages = Array.isArray(round?.weapon_usages) ? round.weapon_usages : [];

        for (const weapon of usages) {
          const key = `${weapon?.weapon_id ?? ""}__${weapon?.weapon_name || "Unknown Weapon"}`;

          if (!weaponMap.has(key)) {
            weaponMap.set(key, {
              id: weapon?.weapon_id ?? null,
              name: weapon?.weapon_name || `Weapon ID ${weapon?.weapon_id ?? "?"}`,
              image_url: "",
              aggregates: {}
            });
          }

          const row = weaponMap.get(key);

          for (const [k, v] of Object.entries(weapon || {})) {
            if (k === "weapon_id" || k === "weapon_name") continue;

            if (typeof v === "number") {
              row.aggregates[k] = (row.aggregates[k] || 0) + v;
            } else if (typeof v === "boolean") {
              row.aggregates[k] = row.aggregates[k] || 0;
              row.aggregates[k] += v ? 1 : 0;
            } else if (v !== null && v !== undefined && v !== "") {
              if (!(k in row.aggregates)) row.aggregates[k] = v;
            }
          }
        }
      }

      const list = [...weaponMap.values()];

      list.sort((a, b) => {
        const aScore = Number(a.aggregates.kills || 0);
        const bScore = Number(b.aggregates.kills || 0);
        return bScore - aScore || a.name.localeCompare(b.name);
      });

      for (const weapon of list) {
        const asset = getWeaponAsset(weapon.name);
        weapon.image_url = asset?.image_url || "";
      }

      return list;
    }

    function getLatestRoundStat(player) {
      const rounds = Array.isArray(player?.round_stats) ? [...player.round_stats] : [];
      if (!rounds.length) return null;
      rounds.sort((a, b) => toNum(b?.round_index, -1) - toNum(a?.round_index, -1));
      return rounds[0];
    }

    function getLatestItems(player) {
      const round = getLatestRoundStat(player);
      const items = Array.isArray(round?.item_nums) ? round.item_nums : [];

      return items
        .filter(item => toNum(item?.item_num) > 0)
        .map(item => {
          const id = Number(item?.item_id);
          const name = resolveItemName(id, false) || item?.item_name || `Item ID ${id}`;
          const asset = getWeaponAsset(name);

          return {
            id,
            name,
            count: toNum(item?.item_num),
            image_url: asset?.image_url || ""
          };
        });
    }

    function getLatestPurchasedItems(player) {
      const round = getLatestRoundStat(player);
      const purchased = Array.isArray(round?.purchased_items) ? round.purchased_items : [];
      const counts = new Map();

      for (const rawId of purchased) {
        const id = Number(rawId);
        if (!Number.isFinite(id)) continue;
        counts.set(id, (counts.get(id) || 0) + 1);
      }

      return [...counts.entries()]
        .map(([id, count]) => {
          const name = resolveItemName(id, true) || `Item ID ${id}`;
          const asset = getWeaponAsset(name);
          return { id, name, count, image_url: asset?.image_url || "" };
        })
        .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));
    }

    function getDisplayRound(payload, teams = []) {
      let best = -1;

      const matchRounds = payload?.match?.match_stats_extra?.round_stats;
      if (Array.isArray(matchRounds)) {
        for (const r of matchRounds) {
          best = Math.max(best, toNum(r?.round_index, -1));
        }
      }

      for (const team of teams) {
        const players = Array.isArray(team?.player_stats) ? team.player_stats : [];
        for (const player of players) {
          const rounds = Array.isArray(player?.round_stats) ? player.round_stats : [];
          for (const r of rounds) {
            best = Math.max(best, toNum(r?.round_index, -1));
          }
        }
      }

      return best >= 0 ? `ROUND ${best + 1}` : "ROUND —";
    }

    function renderHeroImage(imageUrl, alt) {
      if (!imageUrl) {
        return `<div class="hero-fallback">No Image</div>`;
      }
      return `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(alt)}" loading="lazy">`;
    }

    function renderTooltip(entry) {
      if (!entry || (!entry.skill && !entry.description)) return "";

      const meta = entry.slotType ? `${entry.slotType}${entry.label ? " • " + entry.label : ""}` : (entry.label || "");
      return `
        <div class="hover-popup">
          <div class="hover-title">${escapeHtml(entry.skill || entry.label || "Skill")}</div>
          <div class="hover-meta">${escapeHtml(meta)}</div>
          <div class="hover-body">${escapeHtmlWithBreaks(entry.description || "No description available.")}</div>
        </div>
      `;
    }

    function renderSkillChip(entry) {
      if (!entry) return "";

      return `
        <div class="skill-chip hover-wrap" tabindex="0">
          <div class="skill-chip-icon">
            ${entry.image_url
              ? `<img src="${escapeHtml(entry.image_url)}" alt="${escapeHtml(entry.label)}" loading="lazy">`
              : `<span class="icon-fallback">N/A</span>`
            }
          </div>
          <div class="skill-chip-label">${escapeHtml(entry.label || "—")}</div>
          ${renderTooltip(entry)}
        </div>
      `;
    }

    function renderSingleCard(entry, title, isPrimary = false, subtitle = "") {
      if (!entry || (!entry.name && !entry.title)) {
        return `
          <div class="single-card ${isPrimary ? "primary" : ""}">
            <div class="card-thumb"><span class="icon-fallback">—</span></div>
            <div class="card-copy">
              <div class="card-title">${escapeHtml(title)}</div>
              <div class="card-sub">No data</div>
            </div>
          </div>
        `;
      }

      const name = entry.name || entry.title || title;
      return `
        <div class="single-card ${isPrimary ? "primary" : ""}">
          <div class="card-thumb">
            ${entry.image_url
              ? `<img src="${escapeHtml(entry.image_url)}" alt="${escapeHtml(name)}" loading="lazy">`
              : `<span class="icon-fallback">N/A</span>`
            }
          </div>
          <div class="card-copy">
            <div class="card-title">${escapeHtml(name)}</div>
            <div class="card-sub">${escapeHtml(subtitle || entry.sub || "")}</div>
          </div>
        </div>
      `;
    }

    function buildLoadoutSection(player) {
      const loadout = getPlayerLoadoutEntry(player);
      const subtitle = loadout.id ? `Loadout ID: ${loadout.id}` : "No loadout id found in JSON";

      return `
        <div class="section-box">
          <div class="section-title">Loadout</div>
          ${renderSingleCard(loadout, "Loadout", true, subtitle)}
        </div>
      `;
    }

    function buildItemSnapshotSection(player) {
      const items = getLatestItems(player);

      return `
        <div class="section-box">
          <div class="section-title">Current Items (Latest Round Inventory)</div>
          <div class="slot-stack">
            ${
              items.length
                ? items.map(item => `
                    <div class="slot-box">
                      <div class="slot-thumb">
                        ${item.image_url
                          ? `<img src="${escapeHtml(item.image_url)}" alt="${escapeHtml(item.name)}" loading="lazy">`
                          : `<span class="icon-fallback">N/A</span>`
                        }
                      </div>
                      <div class="slot-copy">
                        <div class="slot-title">${escapeHtml(item.name)}</div>
                        <div class="slot-sub">Count: ${item.count}</div>
                      </div>
                    </div>
                  `).join("")
                : `<div class="empty-lite">No item snapshot found in latest round.</div>`
            }
          </div>
        </div>
      `;
    }

    function buildPurchasedItemsSection(player) {
      const items = getLatestPurchasedItems(player);

      return `
        <div class="section-box">
          <div class="section-title">Purchased Items (Latest Round)</div>
          <div class="purchase-list">
            ${
              items.length
                ? items.map(item => `
                    <div class="purchase-item">
                      <div class="purchase-thumb">
                        ${item.image_url
                          ? `<img src="${escapeHtml(item.image_url)}" alt="${escapeHtml(item.name)}" loading="lazy">`
                          : `<span class="icon-fallback">N/A</span>`
                        }
                      </div>
                      <div class="purchase-copy">
                        <div class="purchase-title">${escapeHtml(item.name)}</div>
                        <div class="purchase-sub">Purchased x${item.count}</div>
                      </div>
                    </div>
                  `).join("")
                : `<div class="empty-lite">No purchased items found in latest round.</div>`
            }
          </div>
        </div>
      `;
    }

    function buildWeaponUsageSection(player) {
      const weapons = getWeapons(player);

      return `
        <div class="section-box">
          <div class="section-title">Weapon Usages (All Rounds Aggregated)</div>
          <div class="stats-sections">
            ${
              weapons.length
                ? weapons.map(weapon => `
                    <div class="stats-category">
                      <div class="stats-category-title">${escapeHtml(weapon.name)}</div>
                      <div class="single-card" style="border:0;border-radius:0;background:transparent;box-shadow:none;padding:10px;">
                        <div class="card-thumb">
                          ${weapon.image_url
                            ? `<img src="${escapeHtml(weapon.image_url)}" alt="${escapeHtml(weapon.name)}" loading="lazy">`
                            : `<span class="icon-fallback">N/A</span>`
                          }
                        </div>
                        <div class="card-copy">
                          <div class="card-title">${escapeHtml(weapon.name)}</div>
                          <div class="card-sub">${weapon.id ? `Weapon ID: ${weapon.id}` : "No weapon ID"}</div>
                        </div>
                      </div>
                      <div class="stats-table">
                        ${
                          Object.keys(weapon.aggregates).length
                            ? Object.entries(weapon.aggregates).map(([k, v]) => `
                                <div class="stats-row">
                                  <div class="stats-key">${escapeHtml(humanizeKey(k))}</div>
                                  <div class="stats-val">${escapeHtml(formatGenericValue(v))}</div>
                                </div>
                              `).join("")
                            : `
                              <div class="stats-row">
                                <div class="stats-key">Stats</div>
                                <div class="stats-val">No weapon usage stats available</div>
                              </div>
                            `
                        }
                      </div>
                    </div>
                  `).join("")
                : `<div class="empty-lite">No weapon usage entries found.</div>`
            }
          </div>
        </div>
      `;
    }

    function categorizeRoundStats(round) {
      const sections = {
        "Round Outcome & Flags": [],
        "Combat Output": [],
        "Damage & Survival": [],
        "Support & Recovery": [],
        "Economy & Purchases": [],
        "Abilities & Utility": [],
        "Other Round Fields": []
      };

      const exclude = new Set(["purchased_items", "weapon_usages", "item_nums"]);

      const map = {
        round_index: "Round Outcome & Flags",
        is_win: "Round Outcome & Flags",
        is_dead: "Round Outcome & Flags",
        is_first_down: "Round Outcome & Flags",
        is_first_taken_down: "Round Outcome & Flags",

        kill: "Combat Output",
        assists: "Combat Output",
        knock_down: "Combat Output",
        headshots: "Combat Output",
        hits: "Combat Output",
        torso_hits: "Combat Output",
        leg_hits: "Combat Output",

        damage: "Damage & Survival",
        real_damage: "Damage & Survival",
        real_damage_taken: "Damage & Survival",

        healing_to_self: "Support & Recovery",
        healing_to_teammates: "Support & Recovery",
        rescue_count: "Support & Recovery",

        economy_spent_self: "Economy & Purchases",
        economy_spent_on_teammates: "Economy & Purchases",
        initial_item_value: "Economy & Purchases",
        airdrop_points: "Economy & Purchases",

        nb_skill_usages: "Abilities & Utility",
        medkit_use: "Abilities & Utility",
        grenade_use: "Abilities & Utility",
        icewall_use: "Abilities & Utility",
        throwable_use: "Abilities & Utility"
      };

      for (const [key, value] of Object.entries(round || {})) {
        if (exclude.has(key)) continue;
        const bucket = map[key] || "Other Round Fields";
        sections[bucket].push([key, value]);
      }

      return sections;
    }

    function buildLatestRoundStatsSection(player) {
      const round = getLatestRoundStat(player);

      if (!round) {
        return `
          <div class="section-box">
            <div class="section-title">Latest Round Stats</div>
            <div class="empty-lite">No round_stats found for this player.</div>
          </div>
        `;
      }

      const sections = categorizeRoundStats(round);

      return `
        <div class="section-box">
          <div class="section-title">Latest Round Stats (Categorized)</div>
          <div class="stats-sections">
            ${Object.entries(sections)
              .filter(([, rows]) => rows.length)
              .map(([title, rows]) => `
                <div class="stats-category">
                  <div class="stats-category-title">${escapeHtml(title)}</div>
                  <div class="stats-table">
                    ${rows.map(([key, value]) => `
                      <div class="stats-row">
                        <div class="stats-key">${escapeHtml(humanizeKey(key))}</div>
                        <div class="stats-val">${escapeHtml(formatGenericValue(value))}</div>
                      </div>
                    `).join("")}
                  </div>
                </div>
              `).join("")}
          </div>
        </div>
      `;
    }

    function renderPlayerLane(player) {
      const playerName = player?.nickname || player?.account_id || "Unknown";
      const activeSkill = getActiveSkillEntry(player);
      const passiveSkills = getPassiveSkillEntries(player);
      const pet = getPetEntry(player);

      return `
        <div class="player-lane">
          <div class="hover-wrap" tabindex="0">
            <div class="hero-card">
              <div class="hero-card-inner">
                ${renderHeroImage(activeSkill.image_url, activeSkill.label)}
              </div>
            </div>
            ${renderTooltip(activeSkill)}
          </div>

          <div class="char-name">${escapeHtml(activeSkill.label || "—")}</div>
          <div class="player-tag">${escapeHtml(playerName)}</div>

          <div class="section-box">
            <div class="section-title">Passive Skills</div>
            <div class="skill-chip-row">
              ${passiveSkills.length
                ? passiveSkills.map(renderSkillChip).join("")
                : `<div class="empty-lite">No passive skills found.</div>`
              }
            </div>
          </div>

          <div class="section-box">
            <div class="section-title">Pet</div>
            <div class="skill-chip-row">
              ${pet?.id
                ? renderSkillChip(pet)
                : `<div class="empty-lite">No pet found.</div>`
              }
            </div>
          </div>

          ${buildLoadoutSection(player)}
          ${buildItemSnapshotSection(player)}
          ${buildPurchasedItemsSection(player)}
          ${buildWeaponUsageSection(player)}
          ${buildLatestRoundStatsSection(player)}
        </div>
      `;
    }

    function renderPlayers(team, playerWrapElId) {
      const playerWrapEl = $(playerWrapElId);
      const players = Array.isArray(team?.player_stats) ? team.player_stats : [];

      if (!players.length) {
        playerWrapEl.innerHTML = `<div class="empty-lite">No players found.</div>`;
        return;
      }

      playerWrapEl.innerHTML = players.map(renderPlayerLane).join("");
    }

    function clearRender() {
      $("teamAName").textContent = "—";
      $("teamBName").textContent = "—";
      $("matchRound").textContent = "ROUND —";
      $("teamAPlayers").innerHTML = "";
      $("teamBPlayers").innerHTML = "";
    }

    function getPayload(data) {
      return Array.isArray(data) ? data[0] : data;
    }

    function getTeamsFromPayload(payload) {
      return Array.isArray(payload?.team_stats) ? payload.team_stats : [];
    }

    async function ensureResourcesLoaded() {
      const tasks = [];
      if (!matchApiLoaded) tasks.push(loadMatchApiLookups());
      if (!assetsLoaded) tasks.push(loadAssetCatalogs());

      if (!tasks.length) return;

      setStatus("Loading missing lookup/image resources...");
      await Promise.all(tasks);

      setStatus(
        `Ready.\n` +
        `match_api → Type0 ${LOOKUPS.storeItems.size}, Type1 ${LOOKUPS.items.size}, Skills ${LOOKUPS.skills.size}, Pets ${LOOKUPS.pets.size}\n` +
        `Images → Characters ${ASSETS.charactersById.size}, Pets ${ASSETS.petsByName.size}, Weapons ${ASSETS.weaponsByName.size}, Loadouts ${ASSETS.loadoutsById.size}`
      );
    }

    async function renderJson() {
      try {
        const raw = $("jsonInput").value.trim();

        if (!raw) {
          clearRender();
          setStatus("Paste JSON first.", true);
          return;
        }

        await ensureResourcesLoaded();

        let data;
        try {
          data = JSON.parse(raw);
        } catch (err) {
          clearRender();
          setStatus(`Invalid JSON:\n${err.message}`, true);
          return;
        }

        const payload = getPayload(data);
        const teams = getTeamsFromPayload(payload);

        if (teams.length < 2) {
          clearRender();
          setStatus("This JSON needs at least 2 teams inside team_stats.", true);
          return;
        }

        $("teamAName").textContent = teams[0]?.team_name || "—";
        $("teamBName").textContent = teams[1]?.team_name || "—";
        $("matchRound").textContent = getDisplayRound(payload, teams);

        renderPlayers(teams[0], "teamAPlayers");
        renderPlayers(teams[1], "teamBPlayers");

        let message = `Rendered ${teams[0]?.team_name || "Team A"} vs ${teams[1]?.team_name || "Team B"}.`;
        if (teams.length > 2) {
          message += ` Found ${teams.length} teams total, so only the first 2 were shown.`;
        }

        setStatus(message);
      } catch (err) {
        setStatus(`Render failed:\n${err.message || err}`, true);
      }
    }

    $("renderBtn").addEventListener("click", renderJson);

    $("reloadLookupBtn").addEventListener("click", async () => {
      matchApiLoaded = false;
      assetsLoaded = false;
      try {
        await warmUp();
      } catch (err) {
        setStatus(`Reload failed:\n${err.message || err}`, true);
      }
    });

    $("clearBtn").addEventListener("click", () => {
      $("jsonInput").value = "";
      clearRender();
      setStatus("Cleared. Paste new JSON to render.");
    });

    warmUp();
  </script>
</body>
</html>
