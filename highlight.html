<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- ✅ mobile-safe area + notch support -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Loadout Builder</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#07090f;
      --bg2:#0b1020;
      --panel: rgba(20, 26, 38, .72);
      --panel2: rgba(14, 18, 28, .70);
      --line: rgba(255,255,255,.08);
      --ink:#f4f6ff;
      --muted:#aab1c5;

      --brand:#ffbd59;
      --brand2:#ff7733;
      --accent:#4dd3ff;

      --radius:16px;
      --radius-lg:22px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);

      --sb-w: 260px;
      --sb-w-collapsed: 82px;

      --skill-active:#4dd3ff;
      --skill-passive:#ff59c7;

      --danger:#ff6b6b;
      --ok:#71d083;
      color-scheme: dark;
    }

    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 18% 12%, rgba(77,211,255,.15), transparent 60%),
        radial-gradient(700px 420px at 85% 18%, rgba(255,189,89,.12), transparent 60%),
        radial-gradient(900px 620px at 50% 110%, rgba(255,119,51,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
      overflow-y:auto;
    }

    body::before, body::after{
      content:"";
      position:fixed;
      inset:auto auto 0 0;
      width:520px; height:520px;
      border-radius:50%;
      border:10px solid rgba(77,211,255,.14);
      transform: translate(-45%, -35%);
      pointer-events:none;
    }
    body::after{
      inset: -120px 0 auto auto;
      width:420px; height:420px;
      border:10px solid rgba(77,211,255,.10);
      transform: translate(38%, 0%);
    }

    a{color:inherit}
    select{
      color-scheme: dark;
      background: rgba(0,0,0,.28);
      color: var(--ink);
    }
    select option{ background:#0b1020; color:var(--ink); }

    :focus-visible{
      outline: 2px solid rgba(77,211,255,.65);
      outline-offset: 2px;
      border-radius: 12px;
    }

    /* Layout */
    .app{
      min-height: 100vh;
      display:flex;
      gap:18px;
      padding:18px;
      max-width: 1440px;
      margin: 0 auto;
      align-items:flex-start;
      position:relative;
    }

    /* ✅ Mobile drawer overlay */
    .sb-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 999;
    }
    .sb-overlay.show{
      opacity: 1;
      pointer-events: auto;
    }

    /* Sidebar */
    .sidebar{
      width: var(--sb-w);
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position: sticky;
      top: 18px;
      height: calc(100vh - 36px);
      transition: width .18s ease;
      flex:0 0 auto;
      z-index: 1000;
    }
    .sidebar.collapsed{ width: var(--sb-w-collapsed); }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:16px 16px 10px 16px;
      border-bottom: 1px solid var(--line);
    }
    .brand-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(255,189,89,.25), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      font-family: Orbitron, sans-serif;
      letter-spacing:.5px;
      color:var(--brand);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      font-family: Orbitron, sans-serif;
      font-size: 1.05rem;
      letter-spacing:.6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 150px;
    }
    .brand small{
      display:block;
      color: var(--muted);
      font-size:.78rem;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 150px;
    }

    .nav-search{
      padding: 12px;
      padding-top: 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .nav-search input{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      outline:none;
      font-size: .9rem;
    }
    .nav-search input::placeholder{color: rgba(170,177,197,.75)}
    .nav-search input:focus{
      box-shadow: 0 0 0 3px rgba(77,211,255,.10);
      border-color: rgba(77,211,255,.22);
    }

    .nav{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
    }
    .nav::-webkit-scrollbar{width:10px}
    .nav::-webkit-scrollbar-thumb{background: rgba(255,255,255,.08); border-radius:10px}
    .nav::-webkit-scrollbar-track{background: transparent}

    .nav-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      color: var(--muted);
      text-decoration:none;
      transition: .2s ease;
      cursor:pointer;
      min-width:0;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      color: var(--ink);
    }
    .nav-item.active{
      background: linear-gradient(135deg, rgba(255,189,89,.14), rgba(77,211,255,.09));
      border-color: rgba(255,189,89,.22);
      color: var(--ink);
    }
    .nav-ico{
      width:26px;height:26px;border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:grid;place-items:center;
      flex: 0 0 auto;
    }
    .nav-ico svg{width:14px;height:14px;opacity:.9}
    .nav-label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    .sidebar.collapsed .brand h1,
    .sidebar.collapsed .brand small,
    .sidebar.collapsed .nav-label{display:none;}
    .sidebar.collapsed .brand{justify-content:center;}
    .sidebar.collapsed .brand-left{justify-content:center;}
    .sidebar.collapsed .nav-item{
      justify-content:center;
      gap:0;
      padding:10px 8px;
    }
    .sidebar.collapsed .nav-search{display:none;}

    .sidebar-note{
      font-size:.75rem;
      color: var(--muted);
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.06);
    }

    /* Main */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width: 0;
      gap: 14px;
    }

    /* Topbar */
    .topbar{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position: sticky;
      top: 18px;
      z-index: 20;
    }

    .icon-btn{
      width:42px;height:42px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.2s ease;
      color: var(--ink);
      flex:0 0 auto;
      -webkit-tap-highlight-color: transparent;
    }
    .icon-btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .icon-btn svg{width:18px;height:18px;opacity:.92}

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
      min-width: 0;
    }

    .userchip{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      max-width: 280px;
      min-width: 0;
    }
    .avatar{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(135deg, rgba(255,189,89,.30), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .usertext{min-width:0}
    .usertext b{
      display:block;
      font-size:.92rem;
      font-family: Orbitron, sans-serif;
      color:var(--brand);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 170px;
    }
    .usertext span{
      display:block;
      font-size:.78rem;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .logout{
      color: rgba(255,255,255,.70);
      text-decoration:none;
      font-size:.85rem;
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      transition:.2s ease;
      cursor:pointer;
      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .logout:hover{
      border-color: rgba(255,77,77,.35);
      color: #ff8d8d;
      box-shadow: 0 0 0 3px rgba(255,77,77,.10);
    }

    /* Card shells */
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-inner{padding:14px}

    .hero{
      position:relative;
      height: 150px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.10)),
        url('https://i.imgur.com/qXFpizS.jpg') center/cover no-repeat;
    }
    .hero::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(420px 220px at 55% 45%, rgba(255,189,89,.16), transparent 60%);
      pointer-events:none;
    }
    .hero-content{
      position:absolute;
      left:16px; right:16px; bottom:14px;
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 12px;
    }
    .hero-title h2{
      font-family: Orbitron, sans-serif;
      font-size: 1.45rem;
      color: var(--brand);
      text-shadow: 0 0 18px rgba(255,189,89,.20);
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Buttons */
    .btn{
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(244,246,255,.88);
      cursor:pointer;
      font-weight:900;
      font-size:.82rem;
      transition:.2s ease;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn:hover{
      background: rgba(0,0,0,.28);
      box-shadow: 0 0 0 3px rgba(77,211,255,.10);
      border-color: rgba(77,211,255,.22);
    }
    .btn.brand{
      background: linear-gradient(135deg, rgba(255,189,89,.18), rgba(255,119,51,.10));
      border-color: rgba(255,189,89,.20);
    }
    .btn.brand:hover{
      box-shadow: 0 0 0 3px rgba(255,189,89,.12);
      border-color: rgba(255,189,89,.28);
    }
    .btn.danger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.22);
      color: rgba(255,230,230,.95);
    }
    .btn.danger:hover{
      box-shadow: 0 0 0 3px rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.32);
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .controls-left{
      color: var(--muted);
      font-weight:800;
      font-size:.9rem;
    }
    .controls-right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    /* Loadout Matrix */
    .matrix-wrap{
      margin-top: 10px;
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .matrix{
      padding: 12px;
      display:grid;
      gap: 10px;
      min-width: 980px;
    }

    .cell{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      overflow:hidden;
      min-height: 78px;
    }
    .cell.head{
      background: rgba(14,18,28,.86);
      border-color: rgba(255,255,255,.10);
      min-height: 64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      gap:10px;
    }
    .cell.head b{
      font-family: Orbitron, sans-serif;
      color: rgba(244,246,255,.92);
      letter-spacing:.35px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
      font-size: .95rem;
    }
    .cell.rowlabel{
      background: rgba(14,18,28,.62);
      display:flex;
      align-items:center;
      padding: 10px 12px;
      color: rgba(244,246,255,.90);
      font-weight: 900;
      letter-spacing:.2px;
      min-height: 64px;
    }
    .rowtag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:.78rem;
      color: rgba(244,246,255,.88);
      white-space:nowrap;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      display:inline-block;
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .dot.active{background: var(--skill-active);}
    .dot.passive{background: var(--skill-passive);}
    .dot.pet{background: rgba(113,208,131,.95);}
    .dot.weapon{background: rgba(255,189,89,.95);}
    .dot.loadout{background: rgba(77,211,255,.75);}

    .slot{
      padding: 10px;
      display:flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      transition: .15s ease;
      -webkit-tap-highlight-color: transparent;
      min-height: 78px;
      position:relative;
    }
    .slot:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,189,89,.18);
    }
    .thumb{
      width:44px;height:58px;border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .thumb img{
      width:100%;height:100%;
      object-fit:cover;
      object-position: top center;
      display:block;
      background: rgba(0,0,0,.16);
    }
    .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      flex: 1 1 auto;
    }
    .meta b{
      font-size:.90rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: rgba(244,246,255,.92);
    }
    .meta small{
      font-size:.76rem;
      font-weight: 900;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size:.72rem;
      font-weight:900;
      color: rgba(244,246,255,.86);
      white-space:nowrap;
      flex:0 0 auto;
    }

    .clear-btn{
      position:absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(244,246,255,.90);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: .15s ease;
    }
    .clear-btn:hover{
      border-color: rgba(255,107,107,.35);
      color: #ff9b9b;
      box-shadow: 0 0 0 3px rgba(255,107,107,.10);
    }

    .loadout-card{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 120px;
    }
    .loadout-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .loadout-title input{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--ink);
      outline:none;
      font-weight: 900;
      font-size: .86rem;
    }
    .loadout-title input:focus{
      box-shadow: 0 0 0 3px rgba(77,211,255,.10);
      border-color: rgba(77,211,255,.22);
    }

    details.descbox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }
    details.descbox summary{
      list-style:none;
      cursor:pointer;
      padding: 10px 12px;
      font-weight: 900;
      color: rgba(244,246,255,.90);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.descbox summary::-webkit-details-marker{display:none;}
    .chev{
      width: 20px; height: 20px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      flex:0 0 auto;
    }
    details[open] .chev{transform: rotate(180deg);}
    .descbody{
      padding: 10px 12px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .descitem{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      padding: 10px 10px;
    }
    .descitem .hd{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .descitem .hd b{
      font-size:.86rem;
      color: var(--brand);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .descitem .hd small{
      font-size:.72rem;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }
    .descitem .txt{
      font-size:.82rem;
      color: rgba(244,246,255,.86);
      line-height: 1.25rem;
      white-space: pre-wrap;  /* ✅ fixes “buggy” line breaks */
      word-break: break-word; /* ✅ fixes weird overflow */
    }

    .muted{color: var(--muted);}

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.70);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display:none;
      justify-content: center;
      align-items: center;
      z-index: 1400;
      padding: 18px;
    }
    .modal.show{display:flex;}

    .modal-card{
      width: min(980px, 100%);
      max-height: min(720px, calc(100vh - 36px));
      overflow:hidden;
      border-radius: 22px;
      background: rgba(14,18,28,.92);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 26px 80px rgba(0,0,0,.65);
      display:flex;
      flex-direction:column;
    }
    .modal-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modal-top b{
      font-family: Orbitron, sans-serif;
      letter-spacing:.4px;
      color: var(--brand);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 80%;
    }
    .modal-body{
      padding: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal-body::-webkit-scrollbar{width:10px}
    .modal-body::-webkit-scrollbar-thumb{background: rgba(255,255,255,.08); border-radius:10px}
    .modal-body::-webkit-scrollbar-track{background: transparent}

    #searchInput{
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      outline:none;
      font-size: .92rem;
      margin-bottom: 12px;
    }
    #searchInput::placeholder{color: rgba(170,177,197,.75)}
    #searchInput:focus{
      box-shadow: 0 0 0 3px rgba(77,211,255,.10);
      border-color: rgba(77,211,255,.22);
    }

    .pick-grid{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
      align-items: stretch;
    }
    .pick{
      width: 92px;
      text-align:center;
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 8px;
      cursor:pointer;
      transition:.15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .pick:hover{
      transform: translateY(-1px);
      border-color: rgba(255,189,89,.20);
      background: rgba(255,255,255,.06);
    }
    .pick img{
      width: 70px;
      height: 94px;
      object-fit: cover;
      object-position: top center;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      transition:.15s ease;
      display:block;
      margin: 0 auto 6px auto;
    }
    .pick.active-skill img{ border-color: rgba(77,211,255,.90); }
    .pick.passive-skill img{ border-color: rgba(255,89,199,.90); }
    .pick.pet-item img{ border-color: rgba(113,208,131,.90); }
    .pick.weapon-item img{ border-color: rgba(255,189,89,.90); }

    .pick .nm{
      font-size:.74rem;
      font-weight:900;
      color: rgba(244,246,255,.88);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pick .rl{
      margin-top: 4px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      font-size:.68rem;
      color: rgba(244,246,255,.80);
      font-weight:900;
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .empty{
      width:100%;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      font-weight: 900;
      text-align: center;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      top: calc(env(safe-area-inset-top) + 14px);
      transform: translateX(-50%);
      background: rgba(14,18,28,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      border-radius: 999px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      z-index: 2000;
      max-width: min(640px, calc(100vw - 24px));
      color: rgba(244,246,255,.92);
      font-weight: 900;
      font-size: .85rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast .t-dot{width:10px;height:10px;border-radius:50%; background: var(--danger); box-shadow: 0 0 0 3px rgba(255,255,255,.06);}

    /* ============================================================
       ✅ MOBILE OPTIMIZATION
       ============================================================ */
    @media (max-width: 980px){
      body::before, body::after{display:none;}

      .app{
        padding: 10px;
        gap: 12px;
        flex-direction: column;
        max-width: 100%;
        margin: 0;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }

      /* Sidebar becomes drawer (not hidden) */
      .sidebar{
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--sb-w);
        border-radius: 0 22px 22px 0;
        transform: translateX(-110%);
        transition: transform .18s ease;
        z-index: 1000;
      }
      .sidebar.open{ transform: translateX(0); }
      .sidebar.collapsed{ width: var(--sb-w); } /* no collapsed mode on mobile */

      .topbar{
        top: env(safe-area-inset-top);
        border-radius: 0;
        border-left: 0;
        border-right: 0;
        margin: -10px -10px 0 -10px; /* edge-to-edge */
        padding: 10px 10px;
        gap: 10px;
        z-index: 50;
      }

      .usertext span{display:none;}
      .usertext b{max-width: 52vw; font-size: .88rem;}

      .hero{height: 120px;}
      .hero-content{left:12px;right:12px;bottom:12px;}
      .hero-title h2{font-size: 1.18rem;}

      .controls-left{width:100%;}
      .controls-right{
        width:100%;
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        justify-content: stretch;
      }
      .controls-right .btn{width:100%; padding: 11px 10px; border-radius: 14px;}
      .controls-right .btn.danger{grid-column: 1 / -1;} /* reset full width */

      .modal{
        align-items:flex-end;
        padding: 10px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
      .modal-card{
        width: 100%;
        max-height: 92vh;
        border-radius: 18px;
      }

      .matrix{min-width: 860px;}
    }

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important; transition:none !important; animation:none !important}
      .icon-btn:hover{transform:none}
      .pick:hover{transform:none}
      .slot:hover{transform:none}
    }
  </style>
</head>

<body>
  <!-- ✅ overlay for mobile drawer -->
  <div class="sb-overlay" id="sbOverlay" aria-hidden="true"></div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar" aria-label="Sidebar Navigation">
      <div class="brand">
        <div class="brand-left">
          <div class="logo">FF</div>
          <div class="brand-text">
            <h1>Free Fire</h1>
            <small class="muted">Caster Dashboard</small>
          </div>
        </div>
      </div>

      <div class="nav-search">
        <input id="navSearch" type="text" placeholder="Search menu..." autocomplete="off" />
      </div>

      <nav class="nav" id="nav">
        <a class="nav-item" href="home.html" data-page="home.html" title="Dashboard">
          <span class="nav-ico">
            <svg viewBox="0 0 24 24" fill="none"><path d="M4 13h7V4H4v9Zm9 7h7V4h-7v16ZM4 20h7v-5H4v5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span class="nav-label">Dashboard</span>
        </a>

        <a class="nav-item" href="character.html" data-page="character.html" title="Character Skills">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Character Skills</span>
        </a>

        <!-- keep this file path the same, but content is now Loadout Builder -->
        <a class="nav-item active" href="character-comparison.html" data-page="character-comparison.html" title="Loadout Builder">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M10 3v18M14 3v18M4 7h6M14 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Loadout Builder</span>
        </a>

        <a class="nav-item" href="pet.html" data-page="pet.html" title="Pets">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M7 14c-1.7 0-3-1.3-3-3S5.3 8 7 8s3 1.3 3 3-1.3 3-3 3Zm10 0c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3ZM7 20c-2.8 0-5-1.8-5-4v-1h6v1c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-1h6v1c0 2.2-2.2 4-5 4H7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Pets</span>
        </a>

        <a class="nav-item" href="weapon.html" data-page="weapon.html" title="Weapons">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M3 21l6-6m0 0 2 2 8-8-2-2-8 8Zm0 0-2-2 4-4 2 2-4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Weapons</span>
        </a>

        <a class="nav-item" href="split-view.html" data-page="split-view.html" title="Split View">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 5h16M4 12h16M4 19h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Split View</span>
        </a>
      </nav>

      <div class="sidebar-note">
        Tip: Click any slot to pick. Descriptions update automatically (no compare button).
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <button class="icon-btn" id="sbToggle" aria-label="Toggle sidebar" title="Toggle sidebar" type="button">
          <svg viewBox="0 0 24 24" fill="none">
            <path id="sbTogglePath" d="M14 7l-5 5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="top-actions">
          <div class="userchip">
            <div class="avatar"></div>
            <div class="usertext">
              <b id="gamertag">PlayerOne</b>
              <span id="userEmail" class="muted">loading…</span>
            </div>
          </div>

          <a class="logout" href="#" id="logoutBtn">Logout</a>
        </div>
      </header>

      <section class="card">
        <div class="hero">
          <div class="hero-content">
            <div class="hero-title">
              <h2>Loadout Builder</h2>
            </div>
          </div>
        </div>

        <div class="card-inner">
          <div class="controls">
            <div class="controls-left">
              Default: <b>4 loadouts</b> (columns). Rows: <b>Active</b>, <b>Passive 1–3</b>, <b>Pet</b>, <b>Weapon</b>, plus <b>Loadout card</b> (collapsible descriptions).
            </div>
            <div class="controls-right">
              <a class="btn" href="dashboard.html">← Dashboard</a>
              <button class="btn brand" id="addLoadoutBtn" type="button">+ Add Loadout</button>
              <button class="btn" id="removeLoadoutBtn" type="button">− Remove</button>
              <button class="btn danger" id="resetBtn" type="button">Reset All</button>
            </div>
          </div>

          <div class="matrix-wrap">
            <div class="matrix" id="matrix"></div>
          </div>

          <div class="muted" style="font-size:.8rem; padding: 14px 2px 2px 2px;">
            Free Fire Caster © 2025 — Misai Productions Sdn. Bhd.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Picker Modal -->
  <div class="modal" id="pickerModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Pick an item">
      <div class="modal-top">
        <b id="modalTitle">Pick</b>
        <button class="icon-btn" id="modalCloseBtn" aria-label="Close" title="Close" type="button">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <input type="text" id="searchInput" placeholder="Search (name / role / skill / description)..." />
        <div id="modalGrid" class="pick-grid"></div>
        <div style="display:flex; justify-content:center; margin-top:12px;">
          <button class="btn brand" id="modalCloseBtn2" type="button">Close ✕</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <span class="t-dot"></span>
    <span id="toastMsg">—</span>
  </div>

  <script>
    /***********************
     * Supabase Auth
     ***********************/
    const client = supabase.createClient(
      'https://ooutjrewmwsixghbouxi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vdXRqcmV3bXdzaXhnaGJvdXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjg3NTMsImV4cCI6MjA4MjYwNDc1M30.13WkdGiQH39lZH3iDgVDd_tZrHlI0twhGeiZNdwaMSg'
    );

    async function ensureSession(){
      try{
        const { data: { session } } = await client.auth.getSession();
        if (!session) { window.location.href = "index.html"; return null; }
        return session;
      }catch(_){
        window.location.href = "index.html";
        return null;
      }
    }
    async function logout(){
      try{ await client.auth.signOut(); }catch(_){}
      window.location.href = "index.html";
    }

    /***********************
     * Toast
     ***********************/
    const toastEl = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    let toastTimer = null;
    function toast(message){
      toastMsg.textContent = message || '';
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1700);
    }

    /***********************
     * ✅ Sidebar behavior (desktop collapse / mobile drawer)
     ***********************/
    const CFG = Object.freeze({ SIDEBAR_KEY: 'ff_sidebar_collapsed_v1' });

    const sidebar = document.getElementById('sidebar');
    const sbToggle = document.getElementById('sbToggle');
    const sbTogglePath = document.getElementById('sbTogglePath');
    const sbOverlay = document.getElementById('sbOverlay');
    const mobileMQ = window.matchMedia('(max-width: 980px)');
    const isMobile = () => mobileMQ.matches;

    function setToggleIcon(){
      if (isMobile()){
        sbTogglePath.setAttribute('d', 'M4 7h16M4 12h16M4 17h16');
      }else{
        sbTogglePath.setAttribute('d',
          sidebar.classList.contains('collapsed')
            ? 'M10 7l5 5-5 5'
            : 'M14 7l-5 5 5 5'
        );
      }
    }
    function openDrawer(){
      sidebar.classList.add('open');
      sbOverlay.classList.add('show');
      sbOverlay.setAttribute('aria-hidden','false');
    }
    function closeDrawer(){
      sidebar.classList.remove('open');
      sbOverlay.classList.remove('show');
      sbOverlay.setAttribute('aria-hidden','true');
    }
    function toggleSidebar(){
      if (isMobile()){
        sidebar.classList.contains('open') ? closeDrawer() : openDrawer();
      }else{
        sidebar.classList.toggle('collapsed');
        localStorage.setItem(CFG.SIDEBAR_KEY, sidebar.classList.contains('collapsed') ? '1' : '0');
      }
      setToggleIcon();
    }
    function syncSidebarMode(){
      if (isMobile()){
        sidebar.classList.remove('collapsed');
        closeDrawer();
      }else{
        const saved = localStorage.getItem(CFG.SIDEBAR_KEY);
        sidebar.classList.toggle('collapsed', saved === '1');
        closeDrawer();
      }
      setToggleIcon();
    }

    sbToggle?.addEventListener('click', toggleSidebar);
    sbOverlay?.addEventListener('click', closeDrawer);
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMobile() && sidebar.classList.contains('open')) closeDrawer();
    });
    document.querySelectorAll('#nav .nav-item').forEach(a => {
      a.addEventListener('click', () => { if (isMobile()) closeDrawer(); });
    });
    mobileMQ.addEventListener?.('change', syncSidebarMode);

    document.getElementById('navSearch')?.addEventListener('input', (e) => {
      const q = (e.target.value || '').toLowerCase().trim();
      document.querySelectorAll('#nav .nav-item').forEach(a => {
        const txt = (a.textContent || '').toLowerCase();
        a.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    });
    document.getElementById('logoutBtn')?.addEventListener('click', (e) => { e.preventDefault(); logout(); });

    /***********************
     * Data Sources
     ***********************/
    const CHAR_URLS = [
      'https://misai-my.github.io/freefire-esports/character.json',
      'https://neptuneg1.github.io/freefire-caster/character.json'
    ];
    const PET_URLS = [
      'https://misai-my.github.io/freefire-esports/pet.json',
      'https://neptuneg1.github.io/freefire-caster/pet.json'
    ];
    const WEAPON_URLS = [
      'https://misai-my.github.io/freefire-esports/weapon.json',
      'https://neptuneg1.github.io/freefire-caster/weapon.json',
      'https://misai-my.github.io/freefire-esports/weapons.json',
      'https://neptuneg1.github.io/freefire-caster/weapons.json'
    ];

    let allCharacters = [];
    let allPets = [];
    let allWeapons = [];

    let charByName = new Map();
    let petByName = new Map();
    let weaponByName = new Map();

    function tidy(v){
      return (v ?? '').toString()
        .replace(/[\u200B-\u200D\uFEFF]/g, '')
        .replace(/\r\n/g, '\n')
        .replace(/\s*\n+\s*/g, '\n') // ✅ preserve line breaks
        .replace(/[ \t]{2,}/g, ' ')
        .trim();
    }
    const keyName = (name) => tidy(name).toLowerCase();

    function imgOf(o){ return tidy(o?.image_url) || tidy(o?.img) || tidy(o?.image) || tidy(o?.icon) || ''; }
    function skillOf(o){ return tidy(o?.skill) || tidy(o?.ability) || tidy(o?.name_skill) || ''; }
    function descOf(o){
      return tidy(o?.description) || tidy(o?.desc) || tidy(o?.details) || tidy(o?.info) || '';
    }
    function roleOf(o){
      return tidy(o?.role) || tidy(o?.type) || tidy(o?.category) || tidy(o?.class) || '';
    }
    function skillTypeOfChar(c){
      const st = tidy(c?.skill_type).toLowerCase();
      return st.includes('passive') ? 'Passive' : 'Active';
    }

    function buildIndexes(){
      charByName = new Map();
      for (const c of allCharacters){
        const nm = keyName(c?.name);
        if (nm && !charByName.has(nm)) charByName.set(nm, c);
      }
      petByName = new Map();
      for (const p of allPets){
        const nm = keyName(p?.name);
        if (nm && !petByName.has(nm)) petByName.set(nm, p);
      }
      weaponByName = new Map();
      for (const w of allWeapons){
        const nm = keyName(w?.name);
        if (nm && !weaponByName.has(nm)) weaponByName.set(nm, w);
      }
    }

    async function fetchJSONFrom(urls){
      let lastErr = null;
      for (const url of urls){
        try{
          const res = await fetch(url + `?v=${Date.now()}`, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Bad JSON (not array)');
          return data;
        }catch(err){ lastErr = err; }
      }
      console.warn('Fetch failed:', lastErr);
      return [];
    }

    /***********************
     * State: Loadouts (default 4 columns)
     ***********************/
    const STORE_KEY = 'ff_loadout_builder_v1';

    function makeLoadout(i){
      return {
        name: `Loadout ${i+1}`,
        active: null,           // character name
        passives: [null,null,null], // character names
        pet: null,              // pet name
        weapon: null            // weapon name
      };
    }

    const state = {
      loadouts: [makeLoadout(0), makeLoadout(1), makeLoadout(2), makeLoadout(3)]
    };

    function packState(){
      return {
        loadouts: state.loadouts.map(l => ({
          name: tidy(l.name) || 'Loadout',
          active: l.active,
          passives: Array.isArray(l.passives) ? l.passives.slice(0,3) : [null,null,null],
          pet: l.pet,
          weapon: l.weapon
        }))
      };
    }

    function persist(){
      try{ sessionStorage.setItem(STORE_KEY, JSON.stringify(packState())); }catch(_){}
    }

    function restore(){
      try{
        const raw = sessionStorage.getItem(STORE_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (!obj || !Array.isArray(obj.loadouts)) return;

        state.loadouts = obj.loadouts.map((l, i) => ({
          name: tidy(l?.name) || `Loadout ${i+1}`,
          active: l?.active ?? null,
          passives: Array.isArray(l?.passives) ? (l.passives.concat([null,null,null]).slice(0,3)) : [null,null,null],
          pet: l?.pet ?? null,
          weapon: l?.weapon ?? null
        }));
      }catch(_){}
    }

    /***********************
     * Matrix Rendering
     ***********************/
    const matrixEl = document.getElementById('matrix');

    const ROWS = [
      { key:'loadout', label:'Loadout', dot:'loadout' },
      { key:'active', label:'Active', dot:'active' },
      { key:'passive0', label:'Passive 1', dot:'passive' },
      { key:'passive1', label:'Passive 2', dot:'passive' },
      { key:'passive2', label:'Passive 3', dot:'passive' },
      { key:'pet', label:'Pet', dot:'pet' },
      { key:'weapon', label:'Weapon', dot:'weapon' }
    ];

    function setGridColumns(cols){
      // 160px label + each loadout column
      const colStr = ['160px', ...Array.from({length: cols}, () => 'minmax(200px, 1fr)')].join(' ');
      matrixEl.style.gridTemplateColumns = colStr;
    }

    function textNode(el, txt){
      el.textContent = (txt ?? '').toString();
      return el;
    }

    function buildRowLabelCell(row){
      const c = document.createElement('div');
      c.className = 'cell rowlabel';
      c.innerHTML = `<span class="rowtag"><span class="dot ${row.dot}"></span>${row.label}</span>`;
      return c;
    }

    function buildHeadCell(idx){
      const c = document.createElement('div');
      c.className = 'cell head';
      const b = document.createElement('b');
      b.textContent = `#${idx+1}`;
      c.appendChild(b);

      const mini = document.createElement('span');
      mini.className = 'muted';
      mini.style.fontSize = '.78rem';
      mini.style.fontWeight = '900';
      mini.textContent = 'Auto';
      c.appendChild(mini);
      return c;
    }

    function getChar(nm){ return nm ? charByName.get(keyName(nm)) : null; }
    function getPet(nm){ return nm ? petByName.get(keyName(nm)) : null; }
    function getWeapon(nm){ return nm ? weaponByName.get(keyName(nm)) : null; }

    function slotMetaFor(kind, obj){
      if (!obj) return '';
      if (kind === 'active' || kind.startsWith('passive')){
        const st = tidy(obj?.skill_type) || (kind === 'active' ? 'Active' : 'Passive');
        const rl = tidy(obj?.role) || 'N/A';
        const sk = skillOf(obj);
        return [st, rl, sk].filter(Boolean).join(' • ');
      }
      if (kind === 'pet'){
        const rl = roleOf(obj) || 'Pet';
        const sk = skillOf(obj);
        return [rl, sk].filter(Boolean).join(' • ');
      }
      if (kind === 'weapon'){
        const rl = roleOf(obj) || 'Weapon';
        return rl;
      }
      return '';
    }

    function slotPlaceholder(kind){
      if (kind === 'active') return { title:'Pick Active', sub:'Active Skill' };
      if (kind.startsWith('passive')) return { title:'Pick Passive', sub:'Passive Skill' };
      if (kind === 'pet') return { title:'Pick Pet', sub:'Pet' };
      if (kind === 'weapon') return { title:'Pick Weapon', sub:'Weapon' };
      return { title:'Pick', sub:'' };
    }

    function buildSlotCell(loadoutIndex, kind){
      const cell = document.createElement('div');
      cell.className = 'cell';

      if (kind === 'loadout'){
        const wrap = document.createElement('div');
        wrap.className = 'loadout-card';

        const top = document.createElement('div');
        top.className = 'loadout-title';

        const input = document.createElement('input');
        input.value = state.loadouts[loadoutIndex].name || `Loadout ${loadoutIndex+1}`;
        input.setAttribute('aria-label', `Loadout ${loadoutIndex+1} name`);
        input.addEventListener('input', () => {
          state.loadouts[loadoutIndex].name = input.value;
          persist();
        });

        top.appendChild(input);
        wrap.appendChild(top);

        const details = document.createElement('details');
        details.className = 'descbox';
        // keep collapsed by default (better for clutter)
        const summary = document.createElement('summary');

        const sLeft = document.createElement('span');
        sLeft.textContent = 'Descriptions';
        const chev = document.createElement('span');
        chev.className = 'chev';
        chev.innerHTML = `<svg viewBox="0 0 24 24" width="14" height="14" fill="none">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
        summary.appendChild(sLeft);
        summary.appendChild(chev);
        details.appendChild(summary);

        const body = document.createElement('div');
        body.className = 'descbody';
        body.appendChild(buildDescriptionsForLoadout(loadoutIndex));
        details.appendChild(body);

        wrap.appendChild(details);
        cell.appendChild(wrap);
        return cell;
      }

      let selectedObj = null;
      let selectedName = null;

      const l = state.loadouts[loadoutIndex];
      if (kind === 'active'){ selectedName = l.active; selectedObj = getChar(selectedName); }
      else if (kind.startsWith('passive')){
        const pi = Number(kind.replace('passive','')) || 0;
        selectedName = l.passives[pi];
        selectedObj = getChar(selectedName);
      }
      else if (kind === 'pet'){ selectedName = l.pet; selectedObj = getPet(selectedName); }
      else if (kind === 'weapon'){ selectedName = l.weapon; selectedObj = getWeapon(selectedName); }

      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.setAttribute('role','button');
      slot.setAttribute('tabindex','0');

      const ph = slotPlaceholder(kind);

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const img = imgOf(selectedObj);
      if (img){
        const im = document.createElement('img');
        im.src = img;
        im.alt = tidy(selectedObj?.name) || '';
        im.loading = 'lazy';
        im.referrerPolicy = 'no-referrer';
        thumb.appendChild(im);
      }

      const meta = document.createElement('div');
      meta.className = 'meta';
      const b = document.createElement('b');
      b.textContent = selectedObj ? (tidy(selectedObj?.name) || '—') : ph.title;

      const sm = document.createElement('small');
      sm.textContent = selectedObj ? slotMetaFor(kind, selectedObj) : ph.sub;

      meta.appendChild(b);
      meta.appendChild(sm);

      const pill = document.createElement('span');
      pill.className = 'pill';
      if (kind === 'active') pill.innerHTML = `<span class="dot active"></span>Active`;
      else if (kind.startsWith('passive')) pill.innerHTML = `<span class="dot passive"></span>Passive`;
      else if (kind === 'pet') pill.innerHTML = `<span class="dot pet"></span>Pet`;
      else if (kind === 'weapon') pill.innerHTML = `<span class="dot weapon"></span>Weapon`;

      slot.appendChild(thumb);
      slot.appendChild(meta);
      slot.appendChild(pill);

      function open(){
        openPicker(loadoutIndex, kind);
      }
      slot.addEventListener('click', open);
      slot.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); }
      });

      // Clear button
      if (selectedObj){
        const clear = document.createElement('button');
        clear.className = 'clear-btn';
        clear.type = 'button';
        clear.title = 'Clear';
        clear.setAttribute('aria-label','Clear selection');
        clear.textContent = '×';
        clear.addEventListener('click', (e) => {
          e.stopPropagation();
          clearSelection(loadoutIndex, kind);
        });
        slot.appendChild(clear);
      }

      cell.appendChild(slot);
      return cell;
    }

    function buildDescriptionsForLoadout(loadoutIndex){
      const wrap = document.createElement('div');
      const l = state.loadouts[loadoutIndex];

      const items = [];

      // Active + passives (characters)
      const a = getChar(l.active);
      if (a) items.push({ title: tidy(a.name), kind: 'Active', skill: skillOf(a), desc: descOf(a) });

      l.passives.forEach((nm, i) => {
        const p = getChar(nm);
        if (p) items.push({ title: tidy(p.name), kind: `Passive ${i+1}`, skill: skillOf(p), desc: descOf(p) });
      });

      // Pet
      const pet = getPet(l.pet);
      if (pet) items.push({ title: tidy(pet.name), kind: 'Pet', skill: skillOf(pet), desc: descOf(pet) });

      // Weapon
      const w = getWeapon(l.weapon);
      if (w) items.push({ title: tidy(w.name), kind: 'Weapon', skill: skillOf(w), desc: descOf(w) });

      if (!items.length){
        const em = document.createElement('div');
        em.className = 'muted';
        em.style.fontWeight = '900';
        em.style.fontSize = '.82rem';
        em.textContent = 'No selections yet. Pick items above and this will auto-fill.';
        wrap.appendChild(em);
        return wrap;
      }

      for (const it of items){
        const box = document.createElement('div');
        box.className = 'descitem';

        const hd = document.createElement('div');
        hd.className = 'hd';

        const left = document.createElement('b');
        left.textContent = it.title || '—';

        const right = document.createElement('small');
        right.textContent = it.kind + (it.skill ? ` • ${it.skill}` : '');

        hd.appendChild(left);
        hd.appendChild(right);

        const txt = document.createElement('div');
        txt.className = 'txt';
        // ✅ bug fix: use textContent (no innerHTML), preserve line breaks via CSS
        txt.textContent = it.desc || '—';

        box.appendChild(hd);
        box.appendChild(txt);

        wrap.appendChild(box);
      }

      return wrap;
    }

    function renderMatrix(){
      const cols = state.loadouts.length;
      setGridColumns(cols);
      matrixEl.innerHTML = '';

      // Header row
      const head0 = document.createElement('div');
      head0.className = 'cell head';
      head0.innerHTML = `<b style="color:var(--brand);">Slots</b>`;
      matrixEl.appendChild(head0);

      for (let c=0; c<cols; c++){
        matrixEl.appendChild(buildHeadCell(c));
      }

      // Rows
      for (const row of ROWS){
        matrixEl.appendChild(buildRowLabelCell(row));
        for (let c=0; c<cols; c++){
          matrixEl.appendChild(buildSlotCell(c, row.key));
        }
      }

      // Enable/disable remove button
      document.getElementById('removeLoadoutBtn').disabled = state.loadouts.length <= 1;
    }

    /***********************
     * Picker Modal
     ***********************/
    const modal = document.getElementById('pickerModal');
    const modalGrid = document.getElementById('modalGrid');
    const modalInput = document.getElementById('searchInput');
    const modalTitle = document.getElementById('modalTitle');

    let pickCtx = { loadoutIndex: 0, kind: 'active' };

    function openPicker(loadoutIndex, kind){
      pickCtx = { loadoutIndex, kind };

      const titleMap = {
        active: 'Pick Active',
        passive0: 'Pick Passive 1',
        passive1: 'Pick Passive 2',
        passive2: 'Pick Passive 3',
        pet: 'Pick Pet',
        weapon: 'Pick Weapon'
      };
      modalTitle.textContent = `${titleMap[kind] || 'Pick'} — Loadout #${loadoutIndex+1}`;

      modalInput.value = '';
      renderPickerGrid('');

      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      setTimeout(() => modalInput.focus(), 0);
    }

    function closePicker(){
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
    }

    function renderPickerGrid(term){
      const q = tidy(term).toLowerCase();
      modalGrid.innerHTML = '';

      const kind = pickCtx.kind;

      let list = [];
      if (kind === 'active' || kind.startsWith('passive')){
        const need = (kind === 'active') ? 'Active' : 'Passive';
        list = allCharacters
          .filter(c => skillTypeOfChar(c) === need)
          .map(c => ({
            obj: c,
            blob: [
              tidy(c?.name), tidy(c?.role), tidy(c?.skill), tidy(c?.description), tidy(c?.skill_type)
            ].filter(Boolean).join(' ').toLowerCase()
          }));
      }else if (kind === 'pet'){
        list = allPets.map(p => ({
          obj: p,
          blob: [tidy(p?.name), roleOf(p), skillOf(p), descOf(p)].filter(Boolean).join(' ').toLowerCase()
        }));
      }else if (kind === 'weapon'){
        list = allWeapons.map(w => ({
          obj: w,
          blob: [tidy(w?.name), roleOf(w), skillOf(w), descOf(w)].filter(Boolean).join(' ').toLowerCase()
        }));
      }

      list = list
        .filter(x => !q || x.blob.includes(q))
        .sort((a,b) => tidy(a.obj?.name).localeCompare(tidy(b.obj?.name)));

      if (!list.length){
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No matches.';
        modalGrid.appendChild(empty);
        return;
      }

      list.forEach(({obj}) => {
        const nm = tidy(obj?.name) || '—';
        const rl = roleOf(obj) || 'N/A';
        const img = imgOf(obj);

        const pick = document.createElement('div');

        if (kind === 'active') pick.className = 'pick active-skill';
        else if (kind.startsWith('passive')) pick.className = 'pick passive-skill';
        else if (kind === 'pet') pick.className = 'pick pet-item';
        else if (kind === 'weapon') pick.className = 'pick weapon-item';
        else pick.className = 'pick';

        pick.innerHTML = `
          ${img ? `<img src="${img}" alt="${nm}" loading="lazy" referrerpolicy="no-referrer">` : `<div class="empty" style="padding:10px;border-radius:14px;">No image</div>`}
          <div class="nm">${nm}</div>
          <div class="rl">${rl}</div>
        `;
        pick.addEventListener('click', () => selectPicked(obj));
        modalGrid.appendChild(pick);
      });
    }

    function selectPicked(obj){
      const nm = tidy(obj?.name);
      if (!nm) return;

      const li = pickCtx.loadoutIndex;
      const kind = pickCtx.kind;
      const l = state.loadouts[li];

      // prevent duplicates of the SAME character inside one loadout (active/passives)
      if (kind === 'active' || kind.startsWith('passive')){
        const key = keyName(nm);
        const taken = []
          .concat(l.active ? [l.active] : [])
          .concat(l.passives.filter(Boolean))
          .some(x => keyName(x) === key);

        // allow replacing the current slot with same selection (no toast)
        const currentName =
          (kind === 'active') ? l.active :
          l.passives[Number(kind.replace('passive','')) || 0];

        if (taken && keyName(currentName) !== key){
          toast(`Already used in Loadout #${li+1}. Pick a different character.`);
          return;
        }
      }

      if (kind === 'active'){
        l.active = nm;
      }else if (kind.startsWith('passive')){
        const pi = Number(kind.replace('passive','')) || 0;
        l.passives[pi] = nm;
      }else if (kind === 'pet'){
        l.pet = nm;
      }else if (kind === 'weapon'){
        l.weapon = nm;
      }

      persist();
      renderMatrix(); // ✅ auto updates the descriptions too
      closePicker();
    }

    function clearSelection(loadoutIndex, kind){
      const l = state.loadouts[loadoutIndex];
      if (kind === 'active'){ l.active = null; }
      else if (kind.startsWith('passive')){
        const pi = Number(kind.replace('passive','')) || 0;
        l.passives[pi] = null;
      }
      else if (kind === 'pet'){ l.pet = null; }
      else if (kind === 'weapon'){ l.weapon = null; }

      persist();
      renderMatrix();
    }

    document.getElementById('modalCloseBtn')?.addEventListener('click', closePicker);
    document.getElementById('modalCloseBtn2')?.addEventListener('click', closePicker);
    modalInput?.addEventListener('input', () => renderPickerGrid(modalInput.value));
    window.addEventListener('click', (e) => { if (e.target === modal) closePicker(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('show')) closePicker(); });

    /***********************
     * Add/Remove/Reset
     ***********************/
    document.getElementById('addLoadoutBtn')?.addEventListener('click', () => {
      state.loadouts.push(makeLoadout(state.loadouts.length));
      persist();
      renderMatrix();
      toast('Added a new loadout column.');
    });

    document.getElementById('removeLoadoutBtn')?.addEventListener('click', () => {
      if (state.loadouts.length <= 1) return;
      state.loadouts.pop();
      persist();
      renderMatrix();
      toast('Removed last loadout.');
    });

    document.getElementById('resetBtn')?.addEventListener('click', () => {
      state.loadouts = [makeLoadout(0), makeLoadout(1), makeLoadout(2), makeLoadout(3)];
      try{ sessionStorage.removeItem(STORE_KEY); }catch(_){}
      renderMatrix();
      toast('Reset complete.');
    });

    /***********************
     * Init
     ***********************/
    window.addEventListener('DOMContentLoaded', async () => {
      syncSidebarMode();

      const session = await ensureSession();
      if (!session) return;

      const email = session.user?.email || '';
      document.getElementById('userEmail').textContent = email || 'signed in';
      document.getElementById('gamertag').textContent = email ? email.split('@')[0] : 'PlayerOne';

      restore();

      // Load data (characters + pets + weapons)
      allCharacters = await fetchJSONFrom(CHAR_URLS);
      allPets = await fetchJSONFrom(PET_URLS);
      allWeapons = await fetchJSONFrom(WEAPON_URLS);

      buildIndexes();

      if (!allCharacters.length) toast('Warning: character.json not loaded.');
      if (!allPets.length) toast('Warning: pet.json not loaded.');
      if (!allWeapons.length) toast('Warning: weapon.json not loaded.');

      renderMatrix();
    });
  </script>
</body>
</html>
