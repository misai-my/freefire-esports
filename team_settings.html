<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Settings — Team Path Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#121212;
      --panel:#1c1c1c;
      --panel2:#181818;
      --ink:#f5f5f5;
      --muted:#b0b0b0;
      --brand:#ffbd59;
      --brand2:#ff7733;
      --line:#333;
      --danger:#ff4d4f;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:radial-gradient(circle at top,#1f1f1f 0,#050505 60%);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    #main{
      width:1112px;
      height:800px;
      border:2px solid #444;
      border-radius:12px;
      overflow:hidden;
      background:var(--panel2);
      display:flex;
      flex-direction:column;
    }

    header{
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(90deg,#151515,#1f1f1f);
      border-bottom:1px solid #333;
    }

    .title-block{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .title-block h1{
      margin:0;
      font-size:1.1rem;
      letter-spacing:0.03em;
    }

    .title-block span{
      font-size:.8rem;
      color:var(--muted);
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:.8rem;
    }

    #user-info{
      color:var(--muted);
    }

    .header-right button{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #555;
      background:#222;
      color:var(--ink);
      font-size:.78rem;
      cursor:pointer;
    }

    .header-right button:hover{
      background:#333;
    }

    main{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:12px 16px 16px;
      gap:10px;
      overflow:hidden;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:6px;
      border-bottom:1px solid var(--line);
    }

    .toolbar-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .toolbar-left strong{
      font-size:.9rem;
    }

    .toolbar-left span{
      font-size:.8rem;
      color:var(--muted);
    }

    .toolbar-right{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:.75rem;
      color:var(--muted);
    }

    button.primary{
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      border:none;
      color:#000;
      padding:8px 14px;
      font-size:.85rem;
      font-weight:600;
      border-radius:999px;
      cursor:pointer;
      box-shadow:0 0 12px rgba(255,189,89,0.3);
    }
    button.primary:disabled{
      opacity:.4;
      cursor:not-allowed;
      box-shadow:none;
    }
    button.primary:hover:not(:disabled){
      filter:brightness(1.05);
    }

    button.secondary{
      background:#252525;
      border:1px solid #444;
      color:var(--ink);
      padding:7px 12px;
      font-size:.8rem;
      border-radius:999px;
      cursor:pointer;
    }
    button.secondary:hover{
      background:#303030;
    }

    #status{
      font-size:.78rem;
      color:var(--muted);
      min-height:18px;
    }

    .rows-wrap{
      flex:1;
      margin-top:8px;
      background:var(--panel);
      border-radius:10px;
      border:1px solid #2a2a2a;
      padding:8px;
      overflow:auto;
    }

    .rows-header{
      display:grid;
      grid-template-columns:40px 2.4fr 1.4fr 2.6fr 80px 60px;
      gap:6px;
      padding:4px 8px 6px;
      border-bottom:1px solid #333;
      font-size:.78rem;
      color:var(--muted);
    }

    .rows-body{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:6px 6px 10px;
    }

    .team-row{
      display:grid;
      grid-template-columns:40px 2.4fr 1.4fr 2.6fr 80px 60px;
      gap:6px;
      align-items:center;
      padding:5px 8px;
      border-radius:8px;
      background:rgba(0,0,0,0.18);
      border:1px solid transparent;
      transition:border .15s ease,background .15s ease;
    }

    .team-row:hover{
      border-color:#3a3a3a;
      background:rgba(255,255,255,0.02);
    }

    .row-index{
      text-align:center;
      font-size:.78rem;
      color:var(--muted);
    }

    .team-row input{
      width:100%;
      padding:6px 7px;
      border-radius:6px;
      border:1px solid #333;
      background:#151515;
      color:var(--ink);
      font-size:.8rem;
    }

    .team-row input:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(255,189,89,0.4);
    }

    .logo-preview{
      width:70px;
      height:38px;
      border-radius:999px;
      border:1px solid #333;
      background:#111;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }

    .logo-preview img{
      width:32px;
      height:32px;
      border-radius:50%;
      object-fit:cover;
      box-shadow:0 0 8px rgba(255,255,255,.4);
    }

    .logo-placeholder{
      font-size:.7rem;
      color:var(--muted);
    }

    .delete-btn{
      width:100%;
      padding:0;
      height:28px;
      border-radius:999px;
      border:1px solid rgba(255,77,79,0.5);
      background:rgba(255,77,79,0.08);
      color:var(--danger);
      font-size:.78rem;
      cursor:pointer;
    }

    .delete-btn:hover{
      background:rgba(255,77,79,0.16);
    }

    .hint{
      margin-top:4px;
      font-size:.78rem;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    .hint a{
      color:var(--brand);
      text-decoration:none;
      font-weight:500;
    }

    .hint a:hover{
      text-decoration:underline;
    }

    @media (max-width:1200px){
      #main{
        width:100%;
        height:100%;
        border-radius:0;
        border:none;
      }
    }
  </style>
</head>
<body>
  <div id="main">
    <header>
      <div class="title-block">
        <h1>Team Settings</h1>
        <span>Shared team names, tags & logos for the Team Path Planner</span>
      </div>
      <div class="header-right">
        <span id="user-info"></span>
        <button onclick="location.href='map.html'">← Back to Map</button>
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <main>
      <div class="toolbar">
        <div class="toolbar-left">
          <strong>Manage Teams</strong>
          <span>Start with 6 teams, add up to 30. This list is shared across users.</span>
        </div>
        <div class="toolbar-right">
          <span class="pill" id="team-count-pill">0 / 30 teams</span>
          <button class="secondary" id="add-team-btn">+ Add Team</button>
          <button class="primary" id="save-btn">Save All Changes</button>
        </div>
      </div>

      <div id="status"></div>

      <div class="rows-wrap">
        <div class="rows-header">
          <span>#</span>
          <span>Team Name</span>
          <span>Tag</span>
          <span>Logo URL</span>
          <span>Preview</span>
          <span>Remove</span>
        </div>
        <div class="rows-body" id="rows-body">
          <!-- Rows injected via JS -->
        </div>
      </div>

      <div class="hint">
        <span>Tip: Use square or circular logos for best results (e.g. 512×512 from imgur or storage bucket).</span>
        <span>Link this data from your planner via <code>teams_pathplanner</code> table.</span>
      </div>
    </main>
  </div>

  <script>
    const client = supabase.createClient(
      'https://ooutjrewmwsixghbouxi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vdXRqcmV3bXdzaXhnaGJvdXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjg3NTMsImV4cCI6MjA4MjYwNDc1M30.13WkdGiQH39lZH3iDgVDd_tZrHlI0twhGeiZNdwaMSg'
    );

    const TABLE_NAME = 'teams_pathplanner';
    const MIN_TEAMS = 6;
    const MAX_TEAMS = 30;

    const rowsBody = document.getElementById('rows-body');
    const addBtn = document.getElementById('add-team-btn');
    const saveBtn = document.getElementById('save-btn');
    const statusEl = document.getElementById('status');
    const countPill = document.getElementById('team-count-pill');

    let rows = []; // { el, id, deleted, inputs, preview }

    // Auth guard
    client.auth.getSession().then(({ data: { session } }) => {
      if (!session) {
        window.location.href = 'index.html';
      } else {
        const userInfo = document.getElementById('user-info');
        if (userInfo && session.user?.email) {
          userInfo.textContent = 'Logged in as: ' + session.user.email;
        }
        loadTeams();
      }
    });

    function logout() {
      client.auth.signOut().then(() => {
        window.location.href = 'index.html';
      });
    }

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || '';
      statusEl.style.color = isError ? '#ff9b9b' : 'var(--muted)';
    }

    function updateCountPill() {
      const activeCount = rows.filter(r => !r.deleted).length;
      countPill.textContent = activeCount + ' / ' + MAX_TEAMS + ' teams';
      addBtn.disabled = activeCount >= MAX_TEAMS;
    }

    function createRow(teamData = {}) {
      const rowEl = document.createElement('div');
      rowEl.className = 'team-row';

      const idxEl = document.createElement('div');
      idxEl.className = 'row-index';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Team Name (e.g. G2 Esports)';
      nameInput.value = teamData.team_name || '';

      const tagInput = document.createElement('input');
      tagInput.type = 'text';
      tagInput.placeholder = 'TAG';
      tagInput.maxLength = 6;
      tagInput.value = teamData.team_tag || '';

      const logoInput = document.createElement('input');
      logoInput.type = 'url';
      logoInput.placeholder = 'https://...';
      logoInput.value = teamData.logo_url || '';

      const previewWrap = document.createElement('div');
      previewWrap.className = 'logo-preview';
      const previewImg = document.createElement('img');
      const placeholder = document.createElement('span');
      placeholder.className = 'logo-placeholder';
      placeholder.textContent = 'No logo';

      if (teamData.logo_url) {
        previewImg.src = teamData.logo_url;
        previewWrap.appendChild(previewImg);
      } else {
        previewWrap.appendChild(placeholder);
      }

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Delete';

      // assemble row
      rowEl.appendChild(idxEl);
      rowEl.appendChild(nameInput);
      rowEl.appendChild(tagInput);
      rowEl.appendChild(logoInput);
      rowEl.appendChild(previewWrap);
      rowEl.appendChild(deleteBtn);

      rowsBody.appendChild(rowEl);

      const rowObj = {
        el: rowEl,
        id: teamData.id || null,
        deleted: false,
        inputs: { nameInput, tagInput, logoInput },
        preview: { wrap: previewWrap, img: previewImg, placeholder }
      };

      rows.push(rowObj);

      // Logo preview change
      logoInput.addEventListener('change', () => {
        const url = logoInput.value.trim();
        previewWrap.innerHTML = '';
        if (url) {
          const img = document.createElement('img');
          img.src = url;
          img.onerror = () => {
            previewWrap.innerHTML = '';
            const ph = document.createElement('span');
            ph.className = 'logo-placeholder';
            ph.textContent = 'Invalid URL';
            previewWrap.appendChild(ph);
          };
          previewWrap.appendChild(img);
        } else {
          const ph = document.createElement('span');
          ph.className = 'logo-placeholder';
          ph.textContent = 'No logo';
          previewWrap.appendChild(ph);
        }
      });

      // Delete row
      deleteBtn.addEventListener('click', () => {
        if (rows.filter(r => !r.deleted).length <= MIN_TEAMS) {
          alert('You must keep at least ' + MIN_TEAMS + ' teams.');
          return;
        }
        rowObj.deleted = true;
        rowEl.style.opacity = 0.35;
        rowEl.style.filter = 'grayscale(0.9)';
        deleteBtn.textContent = 'Deleted';
        deleteBtn.disabled = true;
        updateIndices();
        updateCountPill();
      });

      updateIndices();
      updateCountPill();
    }

    function updateIndices() {
      let index = 1;
      rows.forEach(r => {
        const idxEl = r.el.querySelector('.row-index');
        if (!r.deleted) {
          idxEl.textContent = index;
          index++;
        } else {
          idxEl.textContent = '—';
        }
      });
    }

    async function loadTeams() {
      setStatus('Loading teams...');
      rowsBody.innerHTML = '';
      rows = [];

      const { data, error } = await client
        .from(TABLE_NAME)
        .select('id, team_name, team_tag, logo_url')
        .order('id', { ascending: true });

      if (error) {
        console.error('Error loading teams:', error);
        setStatus('Failed to load teams: ' + error.message, true);
        return;
      }

      if (data && data.length) {
        data.forEach(team => createRow(team));
      }

      // Ensure at least MIN_TEAMS rows
      while (rows.filter(r => !r.deleted).length < MIN_TEAMS) {
        createRow();
      }

      setStatus('Teams loaded.');
      updateCountPill();
    }

    // FIXED: use UPDATE + INSERT, not UPSERT with id
    async function saveTeams() {
      setStatus('Saving teams...');
      saveBtn.disabled = true;

      const toInsert = [];
      const toUpdate = [];
      const toDelete = [];

      // collect changes
      for (const r of rows) {
        if (r.deleted) {
          if (r.id) {
            toDelete.push(r.id);
          }
          continue;
        }

        const name = r.inputs.nameInput.value.trim();
        const tag  = r.inputs.tagInput.value.trim();
        const logo = r.inputs.logoInput.value.trim();

        // Skip completely empty new rows
        if (!name && !tag && !logo) {
          if (r.id) {
            // existing row cleared => delete
            toDelete.push(r.id);
          }
          continue;
        }

        // basic validation
        if (!name || !tag || !logo) {
          setStatus('Each active team must have a name, tag, and logo URL.', true);
          saveBtn.disabled = false;
          return; // abort save
        }

        const payload = {
          team_name: name,
          team_tag: tag,
          logo_url: logo
        };

        if (r.id) {
          payload.id = r.id;
          toUpdate.push(payload);
        } else {
          toInsert.push(payload);
        }
      }

      try {
        // Deletes
        if (toDelete.length) {
          const { error: delError } = await client
            .from(TABLE_NAME)
            .delete()
            .in('id', toDelete);
          if (delError) throw delError;
        }

        // Updates — IMPORTANT: no upsert on identity id
        for (const item of toUpdate) {
          const { id, ...updateData } = item;
          const { error: updError } = await client
            .from(TABLE_NAME)
            .update(updateData)
            .eq('id', id);
          if (updError) throw updError;
        }

        // Inserts (no id included, uses identity default)
        if (toInsert.length) {
          const { error: insError } = await client
            .from(TABLE_NAME)
            .insert(toInsert)
            .select();
          if (insError) throw insError;
        }

        setStatus('Saved successfully.');
        await loadTeams();
      } catch (err) {
        console.error('Save error:', err);
        setStatus('Failed to save teams: ' + err.message, true);
      } finally {
        saveBtn.disabled = false;
      }
    }

    addBtn.addEventListener('click', () => {
      if (rows.filter(r => !r.deleted).length >= MAX_TEAMS) return;
      createRow();
    });

    saveBtn.addEventListener('click', () => {
      saveTeams();
    });
  </script>
</body>
</html>
